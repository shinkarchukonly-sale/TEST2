<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор оценки разработки корпоративного сайта</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FFFFFF;
            color: #1E293B;
            font-size: 14px;
            line-height: 1.5;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #F8FAFC;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #E2E8F0;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #3B82F6;
            margin-bottom: 32px;
            padding: 0 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #E2E8F0;
        }

        .nav-item.active {
            background: #3B82F6;
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .user-block {
            margin-top: auto;
            background: #3B82F6;
            color: white;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3B82F6;
            font-weight: 600;
        }

        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px 48px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1E293B;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3B82F6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: white;
            color: #1E293B;
            border: 1px solid #E2E8F0;
        }

        .btn-secondary:hover {
            background: #F8FAFC;
        }

        .btn-danger {
            background: #FEE2E2;
            color: #DC2626;
            padding: 8px 12px;
        }

        .btn-danger:hover {
            background: #FECACA;
        }

        /* Section */
        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 16px 24px;
            background: #F8FAFC;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E2E8F0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1E293B;
        }

        .section-content {
            padding: 24px;
        }

        /* Page card */
        .page-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .page-header {
            padding: 16px 20px;
            background: #F8FAFC;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .page-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .page-title-input {
            font-size: 16px;
            font-weight: 600;
            border: none;
            background: transparent;
            outline: none;
            padding: 4px 8px;
            border-radius: 4px;
            flex: 1;
            max-width: 400px;
        }

        .page-title-input:focus {
            background: white;
            box-shadow: 0 0 0 2px #3B82F6;
        }

        .page-actions {
            display: flex;
            gap: 8px;
        }

        .chevron {
            transition: transform 0.2s;
        }

        .chevron.expanded {
            transform: rotate(180deg);
        }

        .page-content {
            padding: 20px;
            display: none;
        }

        .page-content.expanded {
            display: block;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: #F8FAFC;
            color: #64748B;
            font-weight: 500;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
            font-size: 13px;
        }

        tbody td {
            padding: 12px 16px;
            border-bottom: 1px solid #E2E8F0;
        }

        tbody tr:hover {
            background: #F1F5F9;
        }

        .text-right {
            text-align: right;
        }

        .total-row {
            background: #EFF6FF !important;
            font-weight: 600;
        }

        /* Badge */
        .badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-easy {
            background: #DCFCE7;
            color: #166534;
        }

        .badge-medium {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .badge-hard {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 12px center;
        }

        .block-category {
            margin-bottom: 20px;
        }

        .block-category-title {
            font-weight: 600;
            color: #64748B;
            margin-bottom: 12px;
            font-size: 13px;
            text-transform: uppercase;
        }

        .block-item {
            padding: 12px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .block-item:hover {
            background: #F8FAFC;
            border-color: #3B82F6;
        }

        .block-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .block-item-hours {
            color: #64748B;
            font-size: 13px;
        }

        /* Summary blocks */
        .summary-block {
            background: #F8FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .summary-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1E293B;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #64748B;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: #1E293B;
        }

        .final-summary {
            background: #FFFFFF;
            color: #1E293B;
            border: 2px solid #3B82F6;
        }

        .final-summary .summary-label {
            color: #64748B;
        }

        .final-summary .summary-value {
            color: #1E293B;
            font-size: 24px;
        }

        .final-summary .summary-title {
            color: #3B82F6;
        }

        .final-summary .cost-display {
            color: #3B82F6;
        }

        .cost-input {
            padding: 8px 12px;
            border: 2px solid #3B82F6;
            border-radius: 8px;
            background: #F8FAFC;
            color: #1E293B;
            font-size: 16px;
            width: 120px;
            text-align: center;
        }

        .cost-display {
            font-size: 32px;
            font-weight: 700;
            margin-top: 12px;
            color: #3B82F6;
        }

        /* Modifiers */
        .modifier-group {
            margin-bottom: 20px;
        }

        .modifier-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            font-size: 13px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            cursor: pointer;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            width: 120px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #F1F5F9;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #F1F5F9;
        }

        .icon-btn.delete:hover {
            background: #FEE2E2;
            color: #DC2626;
        }

        .collapsible-section {
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 16px 20px;
            background: #F8FAFC;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-content {
            display: none;
            padding: 16px 20px;
        }

        .collapsible-content.active {
            display: block;
        }

        .work-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #E2E8F0;
            align-items: center;
        }

        .work-item:last-child {
            border-bottom: none;
        }

        .work-item .work-delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94A3B8;
            transition: all 0.2s;
        }

        .work-item .work-delete-btn:hover {
            background: #FEE2E2;
            color: #DC2626;
        }

        .work-name {
            font-size: 14px;
        }

        .work-formula {
            color: #64748B;
            font-size: 13px;
        }

        .work-hours {
            font-weight: 600;
            text-align: right;
            min-width: 80px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748B;
        }

        .integration-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .integration-checkbox:last-child {
            border-bottom: none;
        }

        .integration-checkbox input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .separator {
            height: 2px;
            background: #E2E8F0;
            margin: 32px 0;
        }

        /* Admin Panel Styles */
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }

        .admin-panel.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }

        .admin-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            border-bottom: 1px solid #E2E8F0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .admin-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1E293B;
        }

        .admin-close {
            width: 40px;
            height: 40px;
            border: none;
            background: #F1F5F9;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .admin-close:hover {
            background: #E2E8F0;
        }

        .admin-body {
            padding: 32px;
        }

        .admin-section {
            margin-bottom: 32px;
        }

        .admin-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .admin-section-title.easy {
            background: #DCFCE7;
            color: #166534;
        }

        .admin-section-title.medium {
            background: #FEF9C3;
            color: #854D0E;
        }

        .admin-section-title.hard {
            background: #FEE2E2;
            color: #991B1B;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .admin-table th {
            text-align: left;
            padding: 12px 16px;
            background: #F8FAFC;
            border-bottom: 2px solid #E2E8F0;
            font-weight: 600;
            color: #64748B;
        }

        .admin-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #E2E8F0;
        }

        .admin-table tr:hover {
            background: #F8FAFC;
        }

        .admin-table input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .admin-table input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .admin-table .block-name {
            font-weight: 500;
            color: #1E293B;
            max-width: 300px;
        }

        .admin-table .total-cell {
            font-weight: 600;
            color: #3B82F6;
            background: #EFF6FF;
        }

        .admin-actions {
            display: flex;
            gap: 12px;
            padding: 24px 32px;
            border-top: 1px solid #E2E8F0;
            background: #F8FAFC;
            position: sticky;
            bottom: 0;
        }

        .admin-actions .btn {
            padding: 12px 24px;
        }

        .admin-add-block {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: #F8FAFC;
            border-radius: 8px;
        }

        .admin-add-block input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
        }

        .admin-add-block select {
            padding: 10px 14px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .delete-block-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FEE2E2;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #DC2626;
            transition: all 0.2s;
        }

        .delete-block-btn:hover {
            background: #FECACA;
        }
        /* Projects view */
        .project-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.2s;
            cursor: default;
        }

        .project-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #93C5FD;
        }

        .project-card.active-project {
            border-color: #3B82F6;
            background: #EFF6FF;
        }

        .project-icon {
            width: 48px;
            height: 48px;
            background: #EFF6FF;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3B82F6;
            flex-shrink: 0;
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-name-input {
            font-size: 16px;
            font-weight: 600;
            color: #1E293B;
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .project-name-input:focus {
            background: white;
            box-shadow: 0 0 0 2px #3B82F6;
        }

        .project-meta {
            font-size: 12px;
            color: #94A3B8;
            margin-top: 4px;
            display: flex;
            gap: 16px;
        }

        .project-stats {
            display: flex;
            gap: 24px;
            flex-shrink: 0;
        }

        .project-stat {
            text-align: center;
        }

        .project-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1E293B;
        }

        .project-stat-label {
            font-size: 11px;
            color: #94A3B8;
            margin-top: 2px;
        }

        .project-cost {
            font-size: 18px;
            font-weight: 700;
            color: #3B82F6;
            white-space: nowrap;
        }

        .project-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .projects-empty {
            text-align: center;
            padding: 80px 20px;
            color: #94A3B8;
        }

        .projects-empty svg {
            margin-bottom: 16px;
            color: #CBD5E1;
        }

        .projects-empty h3 {
            font-size: 18px;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 8px;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">Only. Calculator</div>
            
            <div class="nav-item active" id="navCalculator" onclick="switchView('calculator')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                Калькулятор
            </div>
            
            <div class="nav-item" id="navProjects" onclick="switchView('projects')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Проекты
                <span id="projectsCount" style="margin-left:auto;background:#3B82F6;color:white;border-radius:10px;padding:2px 7px;font-size:11px;font-weight:700;">0</span>
            </div>
            
            <div class="nav-item" onclick="toggleAdminPanel()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                Админка блоков
            </div>
            
            <div class="nav-item" onclick="toggleWorksAdminPanel()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                Админка работ
            </div>
            
            <div class="user-block">
                <div class="user-avatar">М</div>
                <div>
                    <div style="font-weight: 600;">Менеджер</div>
                    <div style="font-size: 12px; opacity: 0.9;">Отдел продаж</div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <div class="header">
                <div>
                    <h1>Калькулятор оценки разработки сайта</h1>
                    <div id="currentProjectLabel" style="font-size:13px;color:#64748B;margin-top:4px;display:none;">
                        Проект: <span id="currentProjectName" style="font-weight:600;color:#3B82F6;"></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Excel
                    </button>
                    <button class="btn btn-secondary" onclick="exportToGanttPro()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        GanttPro
                    </button>
                    <button class="btn btn-primary" onclick="saveProject()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Сохранить
                    </button>
                </div>
            </div>

            <!-- Pages Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Страницы сайта</h2>
                    <button class="btn btn-primary" onclick="addPage()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Добавить страницу
                    </button>
                </div>
                <div class="section-content" id="pagesContainer">
                    <!-- Pages will be rendered here -->
                </div>
            </div>

            <!-- Total for first two pages -->
            <div class="summary-block" style="border-color: #93C5FD;">
                <div class="summary-title">ИТОГО: ГЛАВНАЯ И ВНУТРЕННЯЯ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Аналитика</div>
                        <div class="summary-value" id="firstTwoPagesAnalytics">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Дизайн</div>
                        <div class="summary-value" id="firstTwoPagesDesign">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Front-end</div>
                        <div class="summary-value" id="firstTwoPagesFrontend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Back-end</div>
                        <div class="summary-value" id="firstTwoPagesBackend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Test</div>
                        <div class="summary-value" id="firstTwoPagesTest">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"></div>
                        <div class="summary-value"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ВСЕГО</div>
                        <div class="summary-value" id="firstTwoPagesTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Total for all blocks -->
            <div class="summary-block">
                <div class="summary-title">ИТОГО: ВСЕ СТРАНИЦЫ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Аналитика</div>
                        <div class="summary-value" id="totalBlocksAnalytics">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Дизайн</div>
                        <div class="summary-value" id="totalBlocksDesign">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Front-end</div>
                        <div class="summary-value" id="totalBlocksFrontend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Back-end</div>
                        <div class="summary-value" id="totalBlocksBackend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Test</div>
                        <div class="summary-value" id="totalBlocksTest">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label"></div>
                        <div class="summary-value"></div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ВСЕГО</div>
                        <div class="summary-value" id="totalBlocksTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Fixed Works Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Фиксированные работы</h2>
                </div>
                <div class="section-content">
                    <!-- Analytics Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по аналитике</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content active" id="analyticsWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Design Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по дизайну</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="designWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Frontend Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по разработке: Front-end</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="frontendWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Backend Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по разработке: Back-end</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="backendWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Integrations -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Интеграции</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="integrationsContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Testing Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по тестированию</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="testingWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>

                    <!-- Content Works -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <div style="font-weight: 600;">Работы по контенту</div>
                            <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="collapsible-content" id="contentWorksContent">
                            <!-- Will be rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total with works -->
            <div class="summary-block">
                <div class="summary-title">ИТОГО: ЧАСЫ С РАБОТАМИ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Аналитика</div>
                        <div class="summary-value" id="totalWithWorksAnalytics">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Дизайн</div>
                        <div class="summary-value" id="totalWithWorksDesign">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Front-end</div>
                        <div class="summary-value" id="totalWithWorksFrontend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Back-end</div>
                        <div class="summary-value" id="totalWithWorksBackend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Test</div>
                        <div class="summary-value" id="totalWithWorksTest">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Контент</div>
                        <div class="summary-value" id="totalWithWorksContent">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ВСЕГО</div>
                        <div class="summary-value" id="totalWithWorksTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Modifiers Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Модификаторы проекта</h2>
                </div>
                <div class="section-content">
                    <div class="modifier-group">
                        <label class="modifier-label">АПСЕЙЛ</label>
                        <input type="number" value="0" min="0" id="upsaleHours" onchange="calculateTotals()">
                        <span style="margin-left: 8px; color: #64748B;">доп. часов</span>
                    </div>

                    <div class="modifier-group">
                        <label class="modifier-label">СЛОЖНОСТЬ ЗАКАЗЧИКА</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="clientComplexity" value="0" checked onchange="calculateTotals()">
                                <span>Адекватный</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="clientComplexity" value="10" onchange="calculateTotals()">
                                <span>Сложный (+10%)</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="clientComplexity" value="20" onchange="calculateTotals()">
                                <span>Очень сложный (+20%)</span>
                            </label>
                        </div>
                    </div>

                    <div class="modifier-group">
                        <label class="modifier-label">ВНУТРЕННИЕ ЦЕЛИ</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="internalGoals" value="0" checked onchange="calculateTotals()">
                                <span>Не интересно</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="internalGoals" value="5" onchange="calculateTotals()">
                                <span>Интересно (+5%)</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="internalGoals" value="10" onchange="calculateTotals()">
                                <span>Очень интересно (+10%)</span>
                            </label>
                        </div>
                    </div>

                    <div class="modifier-group">
                        <label class="modifier-label">РЕЛИЗ С MVP</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="mvp" value="0" checked onchange="calculateTotals()">
                                <span>Без MVP</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="mvp" value="15" onchange="calculateTotals()">
                                <span>С MVP (+15%)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total with modifiers -->
            <div class="summary-block">
                <div class="summary-title">ИТОГО: С МОДИФИКАТОРАМИ</div>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Аналитика</div>
                        <div class="summary-value" id="totalModifiedAnalytics">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Дизайн</div>
                        <div class="summary-value" id="totalModifiedDesign">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Front-end</div>
                        <div class="summary-value" id="totalModifiedFrontend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Back-end</div>
                        <div class="summary-value" id="totalModifiedBackend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Test</div>
                        <div class="summary-value" id="totalModifiedTest">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Контент</div>
                        <div class="summary-value" id="totalModifiedContent">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ВСЕГО</div>
                        <div class="summary-value" id="totalModifiedTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Final Project Total -->
            <div class="summary-block final-summary">
                <div class="summary-title" style="font-size: 20px; text-align: center; margin-bottom: 24px;">ИТОГО ПРОЕКТ</div>
                <div class="summary-grid" style="margin-bottom: 24px;">
                    <div class="summary-item">
                        <div class="summary-label">Аналитика</div>
                        <div class="summary-value" id="finalAnalytics">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Дизайн</div>
                        <div class="summary-value" id="finalDesign">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Front-end</div>
                        <div class="summary-value" id="finalFrontend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Back-end</div>
                        <div class="summary-value" id="finalBackend">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Test</div>
                        <div class="summary-value" id="finalTest">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Контент</div>
                        <div class="summary-value" id="finalContent">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ВСЕГО</div>
                        <div class="summary-value" style="font-size: 28px;" id="finalTotalHours">0</div>
                    </div>
                </div>
                <div style="text-align: center; border-top: 2px solid rgba(255,255,255,0.2); padding-top: 20px;">
                    <div style="margin-bottom: 16px;">
                        <span style="font-size: 16px; margin-right: 12px;">Средняя ставка:</span>
                        <input type="number" class="cost-input" value="2500" min="0" id="hourlyRate" onchange="calculateTotals()">
                        <span style="font-size: 16px; margin-left: 8px;">₽/час</span>
                    </div>
                    <div class="summary-label">СТОИМОСТЬ ПРОЕКТА:</div>
                    <div class="cost-display" id="projectCost">0 ₽</div>
                </div>
            </div>
        </div>

        <!-- Projects View (hidden by default, inside app-container) -->
        <div id="projectsView" style="display:none;flex:1;overflow-y:auto;padding:32px 48px;">
        <div class="header">
            <div>
                <h1>Проекты</h1>
                <div style="font-size:13px;color:#64748B;margin-top:4px;">Все сохранённые оценки</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="createNewProject()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Новый проект
                </button>
            </div>
        </div>
        <div id="projectsList"></div>
    </div>
    </div><!-- /app-container -->

    <!-- Modal for adding blocks -->
    <div class="modal" id="blockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить блок</h3>
                <button class="close-btn" onclick="closeBlockModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="text" class="search-input" placeholder="Поиск блока..." id="blockSearch" oninput="filterBlocks()">
                <div id="blocksList">
                    <!-- Blocks will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>Управление блоками</h2>
                <button class="admin-close" onclick="toggleAdminPanel()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="admin-body" id="adminBody">
                <!-- Admin content will be rendered here -->
            </div>
            <div class="admin-actions">
                <button class="btn btn-primary" onclick="saveBlocksData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Сохранить изменения
                </button>
                <button class="btn btn-secondary" onclick="resetBlocksData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    Сбросить к исходным
                </button>
            </div>
        </div>
    </div>

    <!-- Works Admin Panel -->
    <div class="admin-panel" id="worksAdminPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h2>Управление фиксированными работами</h2>
                <button class="admin-close" onclick="toggleWorksAdminPanel()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="admin-body" id="worksAdminBody">
                <!-- Works admin content will be rendered here -->
            </div>
            <div class="admin-actions">
                <button class="btn btn-primary" onclick="saveWorksData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Сохранить изменения
                </button>
                <button class="btn btn-secondary" onclick="resetWorksData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    Сбросить к исходным
                </button>
            </div>
        </div>
    </div>

    <script>
        // Default block database
        const defaultBlocks = {
            easy: [
                { name: 'Футер (подвал)', analytics: 3.9, design: 8, frontend: 9, backend: 6, test: 5.5 },
                { name: 'Промо-блок / баннер с СТА / Промо-шапка / Первый экран', analytics: 2, design: 9, frontend: 6, backend: 2.5, test: 5.5 },
                { name: 'Стандартная шапка', analytics: 3, design: 8, frontend: 2, backend: 4, test: 5.5 },
                { name: 'Текст + изображение', analytics: 1.2, design: 6, frontend: 6, backend: 2, test: 3 },
                { name: 'Аккордеон / FAQ / Раскрывающийся список', analytics: 2, design: 3, frontend: 7, backend: 4, test: 4 },
                { name: 'Преимущества (карточки с текстом/инфографикой, цифры)', analytics: 4, design: 18, frontend: 6, backend: 4, test: 5.5 },
                { name: 'Листинг контактов', analytics: 6, design: 5, frontend: 6, backend: 10, test: 4 },
                { name: 'Документы (слайдер, таблица)', analytics: 4, design: 4, frontend: 8, backend: 5, test: 5.5 },
                { name: 'Системные страницы', analytics: 3, design: 7, frontend: 5, backend: 5, test: 5 },
                { name: 'Прелоадер', analytics: 1, design: 4, frontend: 12, backend: 0, test: 1 }
            ],
            medium: [
                { name: 'Хедер', analytics: 2, design: 4, frontend: 16, backend: 1, test: 5.5 },
                { name: 'Мегаменю простое | Бургер-меню', analytics: 2, design: 10, frontend: 9, backend: 10, test: 4 },
                { name: 'Шапка с виджетами', analytics: 3, design: 20, frontend: 8, backend: 4, test: 5.5 },
                { name: 'Листинг карточек с пагинацией с превью карточек', analytics: 3, design: 4, frontend: 12, backend: 6, test: 5.5 },
                { name: 'Слайдер карточек (универсальный)', analytics: 8, design: 6, frontend: 16, backend: 4, test: 5.5 },
                { name: 'Статья / контентная страница', analytics: 4, design: 8, frontend: 7, backend: 5, test: 16 },
                { name: 'Рекомендуемые материалы', analytics: 2, design: 3, frontend: 8, backend: 5, test: 5.5 },
                { name: 'Карта интерактивная (Яндекс)', analytics: 2, design: 7, frontend: 35, backend: 2, test: 5.5 }
            ],
            hard: [
                { name: 'Табы (вкладки)', analytics: 12, design: 2, frontend: 10, backend: 6, test: 14.5 },
                { name: 'Фильтры', analytics: 6, design: 4, frontend: 20, backend: 5, test: 14.5 },
                { name: 'Результаты поиска', analytics: 2, design: 4, frontend: 15, backend: 6, test: 5.5 },
                { name: 'Пустое состояние поиска', analytics: 1, design: 1, frontend: 0, backend: 0, test: 0 },
                { name: 'Форма обратной связи', analytics: 3, design: 4, frontend: 20, backend: 14, test: 6.5 }
            ]
        };

        // Load blocks from localStorage or use defaults
        let blocks = JSON.parse(JSON.stringify(defaultBlocks));
        function loadBlocksData() {
            try {
                const saved = localStorage.getItem('calculatorBlocks');
                if (saved) {
                    blocks = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading blocks:', e);
            }
        }
        loadBlocksData();

        // Default values for fixed works
        const defaultPercentages = {
            analyticsCuration: 20,
            analyticsOperations: 10,
            analyticsPreparation: 10,
            designOperations: 20,
            designUIKit: 30,
            designUsedBlocks: -20,
            designSupervision: 5,
            frontendOperations: 10,
            frontendReview: 20,
            frontendBugs: 20,
            frontendIntegration: 5,
            backendOperations: 15,
            backendReview: 5,
            backendBugs: 20,
            testingOperations: 10,
            testingProd: 20
        };

        const defaultFixedValues = {
            // Analytics
            analyticsBenchmark: 32,
            analyticsBrief: 16,
            analyticsRequirements: 8,
            analyticsStructure: 24,
            // Design
            designAnimMain: 7,
            designAnimInner: 6,
            designAdaptMain: 7,
            designAdaptAll: 26,
            designUIKitMain: 7,
            // Frontend
            frontendSetup: 8,
            frontendPrototypes: 6,
            frontendAnimMain: 30,
            frontendAnimInner: 40,
            // Backend
            backendSetup: 24,
            backendMultilang: 8,
            backendSearch: 32,
            backendMultilangFront: 16,
            backendSearchFront: 16,
            // Testing
            testingArtifacts: 2,
            testingPrototypes: 2,
            testingDesign: 2,
            testingPerformance: 2,
            testingContent: 11,
            // Content
            contentFill: 60,
            contentInstruction: 16,
            contentTZ: 32
        };

        const defaultIntegrations = {
            crm: { enabled: false, analytics: 1, design: 1, frontend: 0, backend: 50, test: 10 },
            maps: { enabled: false, analytics: 1, design: 1, frontend: 16, backend: 0, test: 0 },
            b24: { enabled: false, analytics: 1, design: 1, frontend: 0, backend: 16, test: 3.2 },
            hh: { enabled: false, analytics: 2, design: 2, frontend: 0, backend: 24, test: 4.8 },
            email: { enabled: false, analytics: 1, design: 1, frontend: 0, backend: 32, test: 8 },
            metrics: { enabled: false, analytics: 0, design: 0, frontend: 8, backend: 1, test: 0.2 },
            chat: { enabled: false, analytics: 0, design: 0, frontend: 16, backend: 1, test: 0.2 }
        };

        // State
        let state = {
            pages: [],
            currentPageForBlock: null,
            percentages: JSON.parse(JSON.stringify(defaultPercentages)),
            integrations: {
                crm: false,
                maps: false,
                b24: false,
                hh: false,
                email: false,
                metrics: false,
                chat: false
            },
            fixedValues: JSON.parse(JSON.stringify(defaultFixedValues)),
            integrationsData: JSON.parse(JSON.stringify(defaultIntegrations)),
            disabledWorks: {
                percentages: [],
                fixed: [],
                integrations: []
            },
            customWorks: {
                analytics: [],
                design: [],
                frontend: [],
                backend: [],
                testing: [],
                content: [],
                integrations: []
            }
        };

        // Initialize
        async function init() {
            try {
                loadWorksData();
                loadState();
                renderFixedWorks();
                if (!state.pages || state.pages.length === 0) {
                    state._skipCalculate = true;
                    addPage('Главная страница');
                    addPage('О компании');
                    state._skipCalculate = false;
                }
                renderPages();
                calculateTotals();
                updateCurrentProjectLabel();
                // Load projects count from Supabase in background
                await loadProjects();
            } catch(e) {
                console.error('init error:', e);
            }
        }

        // Page management
        function addPage(name = null) {
            if (state.pages.length >= 30) {
                alert('Максимум 30 страниц');
                return;
            }
            const pageName = name || `Страница ${state.pages.length + 1}`;
            state.pages.push({
                id: Date.now(),
                name: pageName,
                expanded: true,
                blocks: []
            });
            renderPages();
            if (!state._skipCalculate) {
                calculateTotals();
            }
            saveState();
        }

        function deletePage(pageId) {
            if (state.pages.length <= 1) {
                alert('Должна остаться хотя бы одна страница');
                return;
            }
            if (confirm('Удалить страницу?')) {
                state.pages = state.pages.filter(p => p.id !== pageId);
                renderPages();
                calculateTotals();
                saveState();
            }
        }

        function togglePage(pageId) {
            const page = state.pages.find(p => p.id === pageId);
            if (page) {
                page.expanded = !page.expanded;
                renderPages();
            }
        }

        function updatePageName(pageId, name) {
            const page = state.pages.find(p => p.id === pageId);
            if (page) {
                page.name = name.substring(0, 100);
                saveState();
            }
        }

        // Block management
        function openBlockModal(pageId) {
            state.currentPageForBlock = pageId;
            document.getElementById('blockModal').classList.add('active');
            renderBlocksList();
        }

        function closeBlockModal() {
            document.getElementById('blockModal').classList.remove('active');
            state.currentPageForBlock = null;
            document.getElementById('blockSearch').value = '';
        }

        function renderBlocksList(searchTerm = '') {
            const container = document.getElementById('blocksList');
            const search = searchTerm.toLowerCase();
            
            let html = '';
            
            ['easy', 'medium', 'hard'].forEach(difficulty => {
                const difficultyName = difficulty === 'easy' ? 'ЛЕГКИЕ' : difficulty === 'medium' ? 'СРЕДНИЕ' : 'СЛОЖНЫЕ';
                const badgeClass = difficulty === 'easy' ? 'badge-easy' : difficulty === 'medium' ? 'badge-medium' : 'badge-hard';
                const badgeText = difficulty === 'easy' ? 'Легкий' : difficulty === 'medium' ? 'Средний' : 'Сложный';
                
                const filteredBlocks = blocks[difficulty].filter(b => 
                    b.name.toLowerCase().includes(search)
                );
                
                if (filteredBlocks.length > 0) {
                    html += `<div class="block-category">
                        <div class="block-category-title">${difficultyName}</div>`;
                    
                    filteredBlocks.forEach(block => {
                        const total = block.analytics + block.design + block.frontend + block.backend + block.test;
                        html += `
                            <div class="block-item" onclick="addBlockToPage('${difficulty}', '${block.name.replace(/'/g, "\\'")}')">
                                <div class="block-item-info">
                                    <span>${block.name}</span>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <div class="block-item-hours">${total.toFixed(0)}ч</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            });
            
            container.innerHTML = html || '<div class="empty-state">Блоки не найдены</div>';
        }

        function filterBlocks() {
            const searchTerm = document.getElementById('blockSearch').value;
            renderBlocksList(searchTerm);
        }

        function addBlockToPage(difficulty, blockName) {
            const page = state.pages.find(p => p.id === state.currentPageForBlock);
            if (!page) return;
            
            const blockData = blocks[difficulty].find(b => b.name === blockName);
            if (!blockData) return;
            
            page.blocks.push({
                id: Date.now(),
                ...blockData,
                difficulty
            });
            
            closeBlockModal();
            renderPages();
            calculateTotals();
            saveState();
        }

        function deleteBlock(pageId, blockId) {
            const page = state.pages.find(p => p.id === pageId);
            if (page) {
                page.blocks = page.blocks.filter(b => b.id !== blockId);
                renderPages();
                calculateTotals();
                saveState();
            }
        }

        // Render functions
        function renderPages() {
            const container = document.getElementById('pagesContainer');
            let html = '';
            
            state.pages.forEach(page => {
                const pageTotal = {
                    analytics: page.blocks.reduce((sum, b) => sum + b.analytics, 0),
                    design: page.blocks.reduce((sum, b) => sum + b.design, 0),
                    frontend: page.blocks.reduce((sum, b) => sum + b.frontend, 0),
                    backend: page.blocks.reduce((sum, b) => sum + b.backend, 0),
                    test: page.blocks.reduce((sum, b) => sum + b.test, 0)
                };
                pageTotal.total = pageTotal.analytics + pageTotal.design + pageTotal.frontend + pageTotal.backend + pageTotal.test;
                
                html += `
                    <div class="page-card">
                        <div class="page-header" onclick="togglePage(${page.id})">
                            <div class="page-title-wrapper">
                                <svg class="chevron ${page.expanded ? 'expanded' : ''}" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                                <input type="text" class="page-title-input" value="${page.name}" onclick="event.stopPropagation()" onchange="updatePageName(${page.id}, this.value)">
                            </div>
                            <div class="page-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-primary" onclick="openBlockModal(${page.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    Блок
                                </button>
                                <button class="icon-btn delete" onclick="deletePage(${page.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="page-content ${page.expanded ? 'expanded' : ''}">
                            ${page.blocks.length === 0 ? '<div class="empty-state">Нет блоков. Нажмите "+ Блок" чтобы добавить.</div>' : `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Название блока</th>
                                            <th class="text-right">Аналитика</th>
                                            <th class="text-right">Дизайн</th>
                                            <th class="text-right">Front-end</th>
                                            <th class="text-right">Back-end</th>
                                            <th class="text-right">Test</th>
                                            <th class="text-right">Итого</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${page.blocks.map(block => {
                                            const total = block.analytics + block.design + block.frontend + block.backend + block.test;
                                            const badgeClass = block.difficulty === 'easy' ? 'badge-easy' : block.difficulty === 'medium' ? 'badge-medium' : 'badge-hard';
                                            const badgeText = block.difficulty === 'easy' ? 'Легкий' : block.difficulty === 'medium' ? 'Средний' : 'Сложный';
                                            return `
                                                <tr>
                                                    <td>
                                                        <div>${block.name}</div>
                                                        <span class="badge ${badgeClass}">${badgeText}</span>
                                                    </td>
                                                    <td class="text-right">${block.analytics.toFixed(0)}</td>
                                                    <td class="text-right">${block.design.toFixed(0)}</td>
                                                    <td class="text-right">${block.frontend.toFixed(0)}</td>
                                                    <td class="text-right">${block.backend.toFixed(0)}</td>
                                                    <td class="text-right">${block.test.toFixed(0)}</td>
                                                    <td class="text-right">${total.toFixed(0)}</td>
                                                    <td>
                                                        <button class="icon-btn delete" onclick="deleteBlock(${page.id}, ${block.id})">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                        <tr class="total-row">
                                            <td><strong>ИТОГО ПО СТРАНИЦЕ:</strong></td>
                                            <td class="text-right"><strong>${pageTotal.analytics.toFixed(0)}</strong></td>
                                            <td class="text-right"><strong>${pageTotal.design.toFixed(0)}</strong></td>
                                            <td class="text-right"><strong>${pageTotal.frontend.toFixed(0)}</strong></td>
                                            <td class="text-right"><strong>${pageTotal.backend.toFixed(0)}</strong></td>
                                            <td class="text-right"><strong>${pageTotal.test.toFixed(0)}</strong></td>
                                            <td class="text-right"><strong>${pageTotal.total.toFixed(0)}</strong></td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderFixedWorks() {
            try {
                // Ensure elements exist
                const analyticsEl = document.getElementById('analyticsWorksContent');
                if (!analyticsEl) {
                    console.error('analyticsWorksContent not found');
                    return;
                }

                // Helper function to render work item with delete button
                function workItem(type, key, name, formulaHtml, hoursHtml) {
                    if (state.disabledWorks[type] && state.disabledWorks[type].includes(key)) {
                        return '';
                    }
                    return `
                        <div class="work-item">
                            <button class="work-delete-btn" onclick="disableWorkMain('${type}', '${key}')" title="Удалить">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                            <div class="work-name">${name}</div>
                            <div class="work-formula">${formulaHtml}</div>
                            <div class="work-hours">${hoursHtml}</div>
                        </div>
                    `;
                }
                
            // Analytics Works
            analyticsEl.innerHTML = `
                ${workItem('percentages', 'analyticsCuration', 
                    `Курирование <input type="number" value="${state.percentages.analyticsCuration || 20}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.analyticsCuration=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Аналитика × ${state.percentages.analyticsCuration || 20}%`,
                    `<span id="analyticsCuration">0</span>`
                )}
                ${workItem('percentages', 'analyticsOperations',
                    `Операционка <input type="number" value="${state.percentages.analyticsOperations || 10}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.analyticsOperations=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Аналитика × ${state.percentages.analyticsOperations || 10}%`,
                    `<span id="analyticsOperations">0</span>`
                )}
                ${workItem('fixed', 'analyticsBenchmark',
                    'Анализ конкурентного окружения. Бенчмаркинг',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.analyticsBenchmark || 32}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.analyticsBenchmark=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'analyticsBrief',
                    'Подготовка брифа и интервьюирование стейкхолдеров',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.analyticsBrief || 16}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.analyticsBrief=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'analyticsRequirements',
                    'Составление бизнес требований',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.analyticsRequirements || 8}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.analyticsRequirements=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'analyticsStructure',
                    'Составление структуры',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.analyticsStructure}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.analyticsStructure=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('percentages', 'analyticsPreparation',
                    `Подготовка макетов к следующим этапам <input type="number" value="${state.percentages.analyticsPreparation}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.analyticsPreparation=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Аналитика × ${state.percentages.analyticsPreparation}%`,
                    `<span id="analyticsPreparation">0</span>`
                )}
                ${renderCustomWorks('analytics')}
                ${renderAddButton('analytics')}
            `;

            // Design Works
            document.getElementById('designWorksContent').innerHTML = `
                ${workItem('percentages', 'designOperations',
                    `Операционка <input type="number" value="${state.percentages.designOperations}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.designOperations=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Дизайн × ${state.percentages.designOperations}%`,
                    `<span id="designOperations">0</span>`
                )}
                ${workItem('fixed', 'designAnimMain',
                    'Анимации главной (прелоадер/тз на анимацию)',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.designAnimMain}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.designAnimMain=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'designAnimInner',
                    'Анимация внутренних (тз на анимацию)',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.designAnimInner}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.designAnimInner=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'designAdaptMain',
                    'Адаптивы (главной и 1 внутр)',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.designAdaptMain}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.designAdaptMain=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'designAdaptAll',
                    'Адаптивы всех страниц',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.designAdaptAll}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.designAdaptAll=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'designUIKitMain',
                    'UI-kit (главной и 1 внутр)',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.designUIKitMain}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.designUIKitMain=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('percentages', 'designUIKit',
                    `UI-kit (общий) <input type="number" value="${state.percentages.designUIKit}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.designUIKit=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Дизайн × ${state.percentages.designUIKit}%`,
                    `<span id="designUIKit">0</span>`
                )}
                ${workItem('percentages', 'designUsedBlocks',
                    `Использование готовых блоков <input type="number" value="${Math.abs(state.percentages.designUsedBlocks)}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.designUsedBlocks=-parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Дизайн × ${state.percentages.designUsedBlocks}% (минус)`,
                    `<span id="designUsedBlocks">0</span>`
                )}
                ${workItem('percentages', 'designSupervision',
                    `Авторский надзор <input type="number" value="${state.percentages.designSupervision}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.designSupervision=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ всего Дизайна × ${state.percentages.designSupervision}%`,
                    `<span id="designSupervision">0</span>`
                )}
                ${renderCustomWorks('design')}
                ${renderAddButton('design')}
            `;

            // Frontend Works
            document.getElementById('frontendWorksContent').innerHTML = `
                ${workItem('fixed', 'frontendSetup',
                    'Разворачивание проекта, перенос базовой логики',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.frontendSetup}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.frontendSetup=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'frontendPrototypes',
                    'Оценка прототипов',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.frontendPrototypes}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.frontendPrototypes=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('percentages', 'frontendOperations',
                    `Операционка <input type="number" value="${state.percentages.frontendOperations}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.frontendOperations=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Front-end × ${state.percentages.frontendOperations}%`,
                    `<span id="frontendOperations">0</span>`
                )}
                ${workItem('percentages', 'frontendReview',
                    `Ревью и курирование <input type="number" value="${state.percentages.frontendReview}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.frontendReview=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Front-end × ${state.percentages.frontendReview}%`,
                    `<span id="frontendReview">0</span>`
                )}
                ${workItem('percentages', 'frontendBugs',
                    `Правка багов <input type="number" value="${state.percentages.frontendBugs}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.frontendBugs=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Front-end × ${state.percentages.frontendBugs}%`,
                    `<span id="frontendBugs">0</span>`
                )}
                ${workItem('fixed', 'frontendAnimMain',
                    'Анимации главной страницы',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.frontendAnimMain}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.frontendAnimMain=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'frontendAnimInner',
                    'Анимации внутренних страниц',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.frontendAnimInner}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.frontendAnimInner=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('percentages', 'frontendIntegration',
                    `Интеграции front и back <input type="number" value="${state.percentages.frontendIntegration}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.frontendIntegration=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Front-end × ${state.percentages.frontendIntegration}%`,
                    `<span id="frontendIntegration">0</span>`
                )}
                ${renderCustomWorks('frontend')}
                ${renderAddButton('frontend')}
            `;

            // Backend Works
            document.getElementById('backendWorksContent').innerHTML = `
                ${workItem('fixed', 'backendSetup',
                    'Разворачивание проекта, перенос базовой логики',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.backendSetup}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.backendSetup=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('percentages', 'backendOperations',
                    `Операционка <input type="number" value="${state.percentages.backendOperations}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.backendOperations=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Back-end × ${state.percentages.backendOperations}%`,
                    `<span id="backendOperations">0</span>`
                )}
                ${workItem('percentages', 'backendReview',
                    `Ревью и курирование <input type="number" value="${state.percentages.backendReview}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.backendReview=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Back-end × ${state.percentages.backendReview}%`,
                    `<span id="backendReview">0</span>`
                )}
                ${workItem('percentages', 'backendBugs',
                    `Правка багов <input type="number" value="${state.percentages.backendBugs}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.backendBugs=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Back-end × ${state.percentages.backendBugs}%`,
                    `<span id="backendBugs">0</span>`
                )}
                ${workItem('fixed', 'backendMultilang',
                    'Мультиязычность',
                    `<input type="number" value="${state.fixedValues.backendMultilang}" min="0" style="width:50px;" onchange="state.fixedValues.backendMultilang=parseFloat(this.value);calculateTotals();saveState()"> (back) + <input type="number" value="${state.fixedValues.backendMultilangFront}" min="0" style="width:50px;" onchange="state.fixedValues.backendMultilangFront=parseFloat(this.value);calculateTotals();saveState()"> (front)`,
                    `${state.fixedValues.backendMultilang + state.fixedValues.backendMultilangFront}`
                )}
                ${workItem('fixed', 'backendSearch',
                    'Базовый Поиск',
                    `<input type="number" value="${state.fixedValues.backendSearch}" min="0" style="width:50px;" onchange="state.fixedValues.backendSearch=parseFloat(this.value);calculateTotals();saveState()"> (back) + <input type="number" value="${state.fixedValues.backendSearchFront}" min="0" style="width:50px;" onchange="state.fixedValues.backendSearchFront=parseFloat(this.value);calculateTotals();saveState()"> (front)`,
                    `${state.fixedValues.backendSearch + state.fixedValues.backendSearchFront}`
                )}
                ${renderCustomWorks('backend')}
                ${renderAddButton('backend')}
            `;

            // Integrations - with delete buttons
            function integrationItem(key, label, details) {
                if (state.disabledWorks.integrations && state.disabledWorks.integrations.includes(key)) {
                    return '';
                }
                return `
                    <div class="integration-checkbox">
                        <input type="checkbox" id="int_${key}" ${state.integrations[key] ? 'checked' : ''} onchange="state.integrations.${key}=this.checked;calculateTotals();saveState()">
                        <label for="int_${key}">${label} (${details})</label>
                    </div>
                `;
            }

            document.getElementById('integrationsContent').innerHTML = `
                ${integrationItem('crm', 'Интеграция с CRM', 'Аналитика: 1, Дизайн: 1, Back-end: 50, Test: 10')}
                ${integrationItem('maps', 'Интеграция с Картами', 'Аналитика: 1, Дизайн: 1, Front-end: 16')}
                ${integrationItem('b24', 'Интеграция с B24', 'Аналитика: 1, Дизайн: 1, Back-end: 16, Test: 3.2')}
                ${integrationItem('hh', 'Интеграция с HH', 'Аналитика: 2, Дизайн: 2, Back-end: 24, Test: 4.8')}
                ${integrationItem('email', 'Email-маркетинг / Подписка на рассылку', 'Аналитика: 1, Дизайн: 1, Back-end: 32, Test: 8')}
                ${integrationItem('metrics', 'Интеграция с метрикой', 'Front-end: 8, Back-end: 1, Test: 0.2')}
                ${integrationItem('chat', 'Интеграция с Чатом', 'Front-end: 16, Back-end: 1, Test: 0.2')}
                ${renderCustomWorks('integrations')}
                ${renderAddButton('integrations')}
            `;

            // Testing Works
            document.getElementById('testingWorksContent').innerHTML = `
                ${workItem('percentages', 'testingOperations',
                    `Операционка <input type="number" value="${state.percentages.testingOperations}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.testingOperations=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Test × ${state.percentages.testingOperations}%`,
                    `<span id="testingOperations">0</span>`
                )}
                ${workItem('percentages', 'testingProd',
                    `Тестирование на проде <input type="number" value="${state.percentages.testingProd}" min="0" max="100" style="width:60px;margin-left:8px;" onchange="state.percentages.testingProd=parseFloat(this.value);calculateTotals();saveState()">%`,
                    `= Σ Test × ${state.percentages.testingProd}%`,
                    `<span id="testingProd">0</span>`
                )}
                ${workItem('fixed', 'testingArtifacts',
                    'Отсмотр артефактов с аналитики',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.testingArtifacts}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.testingArtifacts=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'testingPrototypes',
                    'Отсмотр прототипов',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.testingPrototypes}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.testingPrototypes=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'testingDesign',
                    'Отсмотр дизайн-макетов',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.testingDesign}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.testingDesign=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'testingPerformance',
                    'Тестирование производительности (google page inside)',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.testingPerformance}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.testingPerformance=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'testingContent',
                    'Тестирование собранных страниц с контентом',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.testingContent}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.testingContent=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${renderCustomWorks('testing')}
                ${renderAddButton('testing')}
            `;

            // Content Works
            document.getElementById('contentWorksContent').innerHTML = `
                ${workItem('fixed', 'contentFill',
                    'Наполнение контентом',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.contentFill}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.contentFill=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'contentInstruction',
                    'Инструкция для контент-менеджера',
                    'Фиксировано',
                    `<input type="number" value="${state.fixedValues.contentInstruction}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.contentInstruction=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${workItem('fixed', 'contentTZ',
                    'Написание Технического задания',
                    '4 (Анал) + 8 (Front) + 8 (Back) + 4 (Test) + 8 (Контент)',
                    `<input type="number" value="${state.fixedValues.contentTZ}" min="0" style="width:70px;text-align:right;" onchange="state.fixedValues.contentTZ=parseFloat(this.value);calculateTotals();saveState()">`
                )}
                ${renderCustomWorks('content')}
                ${renderAddButton('content')}
            `;
            } catch (e) {
                console.error('renderFixedWorks error:', e);
            }
        }

        // Calculate totals
        function calculateTotals() {
            // 1. Calculate blocks total
            const blocksTotal = {
                analytics: 0,
                design: 0,
                frontend: 0,
                backend: 0,
                test: 0
            };

            state.pages.forEach(page => {
                page.blocks.forEach(block => {
                    blocksTotal.analytics += block.analytics;
                    blocksTotal.design += block.design;
                    blocksTotal.frontend += block.frontend;
                    blocksTotal.backend += block.backend;
                    blocksTotal.test += block.test;
                });
            });

            const blocksTotalSum = blocksTotal.analytics + blocksTotal.design + blocksTotal.frontend + blocksTotal.backend + blocksTotal.test;

            // Update blocks total display
            document.getElementById('totalBlocksAnalytics').textContent = blocksTotal.analytics.toFixed(0);
            document.getElementById('totalBlocksDesign').textContent = blocksTotal.design.toFixed(0);
            document.getElementById('totalBlocksFrontend').textContent = blocksTotal.frontend.toFixed(0);
            document.getElementById('totalBlocksBackend').textContent = blocksTotal.backend.toFixed(0);
            document.getElementById('totalBlocksTest').textContent = blocksTotal.test.toFixed(0);
            document.getElementById('totalBlocksTotal').textContent = blocksTotalSum.toFixed(0);

            // Calculate first two pages total
            const firstTwo = state.pages.slice(0, 2);
            let ft = { analytics: 0, design: 0, frontend: 0, backend: 0, test: 0 };
            firstTwo.forEach(p => p.blocks.forEach(b => {
                ft.analytics += b.analytics;
                ft.design += b.design;
                ft.frontend += b.frontend;
                ft.backend += b.backend;
                ft.test += b.test;
            }));
            document.getElementById('firstTwoPagesAnalytics').textContent = ft.analytics.toFixed(0);
            document.getElementById('firstTwoPagesDesign').textContent = ft.design.toFixed(0);
            document.getElementById('firstTwoPagesFrontend').textContent = ft.frontend.toFixed(0);
            document.getElementById('firstTwoPagesBackend').textContent = ft.backend.toFixed(0);
            document.getElementById('firstTwoPagesTest').textContent = ft.test.toFixed(0);
            document.getElementById('firstTwoPagesTotal').textContent = (ft.analytics + ft.design + ft.frontend + ft.backend + ft.test).toFixed(0);

            // 2. Calculate fixed works
            const fixedWorks = {
                analytics: 0,
                design: 0,
                frontend: 0,
                backend: 0,
                test: 0,
                content: 0
            };

            // Analytics works
            const analyticsCuration = blocksTotal.analytics * (state.percentages.analyticsCuration / 100);
            const analyticsOperations = blocksTotal.analytics * (state.percentages.analyticsOperations / 100);
            const analyticsPreparation = blocksTotal.analytics * (state.percentages.analyticsPreparation / 100);
            
            fixedWorks.analytics = analyticsCuration + analyticsOperations + state.fixedValues.analyticsBenchmark + state.fixedValues.analyticsBrief + state.fixedValues.analyticsRequirements + state.fixedValues.analyticsStructure + analyticsPreparation;

            document.getElementById('analyticsCuration').textContent = analyticsCuration.toFixed(0);
            document.getElementById('analyticsOperations').textContent = analyticsOperations.toFixed(0);
            document.getElementById('analyticsPreparation').textContent = analyticsPreparation.toFixed(0);

            // Design works
            const designOperations = blocksTotal.design * (state.percentages.designOperations / 100);
            const designUIKit = blocksTotal.design * (state.percentages.designUIKit / 100);
            const designUsedBlocks = blocksTotal.design * (state.percentages.designUsedBlocks / 100);
            const designBeforeSupervision = blocksTotal.design + designOperations + state.fixedValues.designAnimMain + state.fixedValues.designAnimInner + state.fixedValues.designAdaptMain + state.fixedValues.designAdaptAll + state.fixedValues.designUIKitMain + designUIKit + designUsedBlocks;
            const designSupervision = designBeforeSupervision * (state.percentages.designSupervision / 100);
            
            fixedWorks.design = designBeforeSupervision + designSupervision;

            document.getElementById('designOperations').textContent = designOperations.toFixed(0);
            document.getElementById('designUIKit').textContent = designUIKit.toFixed(0);
            document.getElementById('designUsedBlocks').textContent = designUsedBlocks.toFixed(0);
            document.getElementById('designSupervision').textContent = designSupervision.toFixed(0);

            // Frontend works
            const frontendOperations = blocksTotal.frontend * (state.percentages.frontendOperations / 100);
            const frontendReview = blocksTotal.frontend * (state.percentages.frontendReview / 100);
            const frontendBugs = blocksTotal.frontend * (state.percentages.frontendBugs / 100);
            const frontendIntegration = blocksTotal.frontend * (state.percentages.frontendIntegration / 100);
            
            fixedWorks.frontend = state.fixedValues.frontendSetup + state.fixedValues.frontendPrototypes + frontendOperations + frontendReview + frontendBugs + state.fixedValues.frontendAnimMain + state.fixedValues.frontendAnimInner + frontendIntegration;

            document.getElementById('frontendOperations').textContent = frontendOperations.toFixed(0);
            document.getElementById('frontendReview').textContent = frontendReview.toFixed(0);
            document.getElementById('frontendBugs').textContent = frontendBugs.toFixed(0);
            document.getElementById('frontendIntegration').textContent = frontendIntegration.toFixed(0);

            // Backend works
            const backendOperations = blocksTotal.backend * (state.percentages.backendOperations / 100);
            const backendReview = blocksTotal.backend * (state.percentages.backendReview / 100);
            const backendBugs = blocksTotal.backend * (state.percentages.backendBugs / 100);
            
            fixedWorks.backend = state.fixedValues.backendSetup + backendOperations + backendReview + backendBugs + state.fixedValues.backendMultilang + state.fixedValues.backendSearch;
            fixedWorks.frontend += state.fixedValues.backendMultilangFront + state.fixedValues.backendSearchFront;

            document.getElementById('backendOperations').textContent = backendOperations.toFixed(0);
            document.getElementById('backendReview').textContent = backendReview.toFixed(0);
            document.getElementById('backendBugs').textContent = backendBugs.toFixed(0);

            // Integrations
            if (state.integrations.crm) {
                fixedWorks.analytics += 1;
                fixedWorks.design += 1;
                fixedWorks.backend += 50;
                fixedWorks.test += 10;
            }
            if (state.integrations.maps) {
                fixedWorks.analytics += 1;
                fixedWorks.design += 1;
                fixedWorks.frontend += 16;
            }
            if (state.integrations.b24) {
                fixedWorks.analytics += 1;
                fixedWorks.design += 1;
                fixedWorks.backend += 16;
                fixedWorks.test += 3.2;
            }
            if (state.integrations.hh) {
                fixedWorks.analytics += 2;
                fixedWorks.design += 2;
                fixedWorks.backend += 24;
                fixedWorks.test += 4.8;
            }
            if (state.integrations.email) {
                fixedWorks.analytics += 1;
                fixedWorks.design += 1;
                fixedWorks.backend += 32;
                fixedWorks.test += 8;
            }
            if (state.integrations.metrics) {
                fixedWorks.frontend += 8;
                fixedWorks.backend += 1;
                fixedWorks.test += 0.2;
            }
            if (state.integrations.chat) {
                fixedWorks.frontend += 16;
                fixedWorks.backend += 1;
                fixedWorks.test += 0.2;
            }

            // Testing works
            const testingOperations = blocksTotal.test * (state.percentages.testingOperations / 100);
            const testingProd = blocksTotal.test * (state.percentages.testingProd / 100);
            
            fixedWorks.test += testingOperations + testingProd + state.fixedValues.testingArtifacts + state.fixedValues.testingPrototypes + state.fixedValues.testingDesign + state.fixedValues.testingPerformance + state.fixedValues.testingContent;

            document.getElementById('testingOperations').textContent = testingOperations.toFixed(0);
            document.getElementById('testingProd').textContent = testingProd.toFixed(0);

            // Content works
            fixedWorks.content = state.fixedValues.contentFill + state.fixedValues.contentInstruction + 8;
            fixedWorks.analytics += 4;
            fixedWorks.frontend += 8;
            fixedWorks.backend += 8;
            fixedWorks.test += 4;

            // Add custom works
            if (state.customWorks) {
                (state.customWorks.analytics || []).forEach(w => fixedWorks.analytics += w.hours);
                (state.customWorks.design || []).forEach(w => fixedWorks.design += w.hours);
                (state.customWorks.frontend || []).forEach(w => fixedWorks.frontend += w.hours);
                (state.customWorks.backend || []).forEach(w => fixedWorks.backend += w.hours);
                (state.customWorks.testing || []).forEach(w => fixedWorks.test += w.hours);
                (state.customWorks.content || []).forEach(w => fixedWorks.content += w.hours);
                (state.customWorks.integrations || []).forEach(w => fixedWorks.backend += w.hours);
            }

            // 3. Total with works
            const totalWithWorks = {
                analytics: blocksTotal.analytics + fixedWorks.analytics,
                design: blocksTotal.design + fixedWorks.design,
                frontend: blocksTotal.frontend + fixedWorks.frontend,
                backend: blocksTotal.backend + fixedWorks.backend,
                test: blocksTotal.test + fixedWorks.test,
                content: fixedWorks.content
            };

            const totalWithWorksSum = totalWithWorks.analytics + totalWithWorks.design + totalWithWorks.frontend + totalWithWorks.backend + totalWithWorks.test + totalWithWorks.content;

            document.getElementById('totalWithWorksAnalytics').textContent = totalWithWorks.analytics.toFixed(0);
            document.getElementById('totalWithWorksDesign').textContent = totalWithWorks.design.toFixed(0);
            document.getElementById('totalWithWorksFrontend').textContent = totalWithWorks.frontend.toFixed(0);
            document.getElementById('totalWithWorksBackend').textContent = totalWithWorks.backend.toFixed(0);
            document.getElementById('totalWithWorksTest').textContent = totalWithWorks.test.toFixed(0);
            document.getElementById('totalWithWorksContent').textContent = totalWithWorks.content.toFixed(0);
            document.getElementById('totalWithWorksTotal').textContent = totalWithWorksSum.toFixed(0);

            // 4. Apply modifiers
            const upsaleHours = parseFloat(document.getElementById('upsaleHours').value) || 0;
            const clientComplexity = parseFloat(document.querySelector('input[name="clientComplexity"]:checked').value) || 0;
            const internalGoals = parseFloat(document.querySelector('input[name="internalGoals"]:checked').value) || 0;
            const mvp = parseFloat(document.querySelector('input[name="mvp"]:checked').value) || 0;

            const percentageModifier = 1 + (clientComplexity / 100) + (internalGoals / 100) + (mvp / 100);

            const totalModified = {
                analytics: totalWithWorks.analytics * percentageModifier,
                design: totalWithWorks.design * percentageModifier,
                frontend: totalWithWorks.frontend * percentageModifier,
                backend: totalWithWorks.backend * percentageModifier,
                test: totalWithWorks.test * percentageModifier,
                content: totalWithWorks.content * percentageModifier
            };

            const totalModifiedSum = totalModified.analytics + totalModified.design + totalModified.frontend + totalModified.backend + totalModified.test + totalModified.content + upsaleHours;

            document.getElementById('totalModifiedAnalytics').textContent = totalModified.analytics.toFixed(0);
            document.getElementById('totalModifiedDesign').textContent = totalModified.design.toFixed(0);
            document.getElementById('totalModifiedFrontend').textContent = totalModified.frontend.toFixed(0);
            document.getElementById('totalModifiedBackend').textContent = totalModified.backend.toFixed(0);
            document.getElementById('totalModifiedTest').textContent = totalModified.test.toFixed(0);
            document.getElementById('totalModifiedContent').textContent = totalModified.content.toFixed(0);
            document.getElementById('totalModifiedTotal').textContent = totalModifiedSum.toFixed(0);

            // 5. Final project total
            document.getElementById('finalAnalytics').textContent = totalModified.analytics.toFixed(0);
            document.getElementById('finalDesign').textContent = totalModified.design.toFixed(0);
            document.getElementById('finalFrontend').textContent = totalModified.frontend.toFixed(0);
            document.getElementById('finalBackend').textContent = totalModified.backend.toFixed(0);
            document.getElementById('finalTest').textContent = totalModified.test.toFixed(0);
            document.getElementById('finalContent').textContent = totalModified.content.toFixed(0);
            document.getElementById('finalTotalHours').textContent = totalModifiedSum.toFixed(0);

            // Calculate cost
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 2500;
            const projectCost = totalModifiedSum * hourlyRate;
            document.getElementById('projectCost').textContent = projectCost.toLocaleString('ru-RU') + ' ₽';
        }

        // Collapsible sections
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const chevron = header.querySelector('.chevron');
            content.classList.toggle('active');
            chevron.classList.toggle('expanded');
        }

        // State management
        function saveState() {
            localStorage.setItem('calculatorState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('calculatorState');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    // Only load pages if they exist
                    if (loaded.pages && loaded.pages.length > 0) {
                        state.pages = loaded.pages;
                    }
                    // Merge percentages
                    if (loaded.percentages) {
                        Object.keys(loaded.percentages).forEach(key => {
                            state.percentages[key] = loaded.percentages[key];
                        });
                    }
                    // Merge fixedValues
                    if (loaded.fixedValues) {
                        Object.keys(loaded.fixedValues).forEach(key => {
                            state.fixedValues[key] = loaded.fixedValues[key];
                        });
                    }
                    // Merge integrations
                    if (loaded.integrations) {
                        Object.keys(loaded.integrations).forEach(key => {
                            state.integrations[key] = loaded.integrations[key];
                        });
                    }
                    // Merge customWorks
                    if (loaded.customWorks) {
                        Object.keys(loaded.customWorks).forEach(key => {
                            if (Array.isArray(loaded.customWorks[key])) {
                                state.customWorks[key] = loaded.customWorks[key];
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('loadState error:', e);
            }
        }

        // Custom works management
        function addCustomWork(category) {
            if (!state.customWorks[category]) {
                state.customWorks[category] = [];
            }
            state.customWorks[category].push({
                id: Date.now(),
                name: 'Новая работа',
                hours: 0
            });
            renderFixedWorks();
            calculateTotals();
            saveState();
        }

        function updateCustomWorkName(category, id, name) {
            const work = state.customWorks[category].find(w => w.id === id);
            if (work) {
                work.name = name;
                saveState();
            }
        }

        function updateCustomWorkHours(category, id, hours) {
            const work = state.customWorks[category].find(w => w.id === id);
            if (work) {
                work.hours = parseFloat(hours) || 0;
                calculateTotals();
                saveState();
            }
        }

        function deleteCustomWork(category, id) {
            state.customWorks[category] = state.customWorks[category].filter(w => w.id !== id);
            renderFixedWorks();
            calculateTotals();
            saveState();
        }

        function renderCustomWorks(category) {
            if (!state.customWorks || !state.customWorks[category]) return '';
            const works = state.customWorks[category] || [];
            return works.map(work => `
                <div class="work-item">
                    <div></div>
                    <div class="work-name"><input type="text" value="${work.name || ''}" style="width:250px;border:1px solid #E2E8F0;border-radius:4px;padding:4px 8px;" onchange="updateCustomWorkName('${category}', ${work.id}, this.value)"></div>
                    <div class="work-formula">Добавлено</div>
                    <div class="work-hours" style="display:flex;align-items:center;gap:8px;">
                        <input type="number" value="${work.hours || 0}" min="0" style="width:70px;text-align:right;" onchange="updateCustomWorkHours('${category}', ${work.id}, this.value)">
                        <button class="icon-btn delete" onclick="deleteCustomWork('${category}', ${work.id})" style="padding:4px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderAddButton(category) {
            return `
                <div style="margin-top:12px;padding-top:12px;border-top:1px dashed #E2E8F0;">
                    <button class="btn btn-secondary" onclick="addCustomWork('${category}')" style="width:100%;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Добавить работу
                    </button>
                </div>
            `;
        }

        // ==================== PROJECTS MANAGEMENT ====================

        const SUPABASE_URL = 'https://vvcnxognhhzsgezumcvu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2Y254b2duaGh6c2dlenVtY3Z1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNTYwODEsImV4cCI6MjA4NzYzMjA4MX0.TWGX-4p6awtmYQY9Vd7zm_7MODgqkznzZnydCdyORZc';
        const TABLE = 'calculator';

        let projects = [];
        let currentProjectId = null;
        let isSaving = false;

        function sbHeaders() {
            return {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };
        }

        async function sbFetch(method, path, body) {
            const res = await fetch(SUPABASE_URL + '/rest/v1/' + path, {
                method,
                headers: sbHeaders(),
                body: body ? JSON.stringify(body) : undefined
            });
            if (!res.ok) {
                const err = await res.text();
                let parsed;
                try { parsed = JSON.parse(err); } catch(e) { parsed = null; }
                const msg = parsed ? (parsed.message || parsed.error || err) : err;
                const code = parsed ? (parsed.code || '') : '';
                throw new Error(`[${res.status}] ${code ? code + ': ' : ''}${msg}`);
            }
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        }

        function getStateSnapshot() {
            return JSON.parse(JSON.stringify({
                pages: state.pages,
                percentages: state.percentages,
                fixedValues: state.fixedValues,
                integrations: state.integrations,
                customWorks: state.customWorks,
                disabledWorks: state.disabledWorks,
                integrationsData: state.integrationsData
            }));
        }

        function calcProjectTotals(snapshot) {
            if (!snapshot || !snapshot.pages) return { hours: 0, pages: 0, blocks: 0 };
            let hours = 0, blockCount = 0;
            snapshot.pages.forEach(p => {
                blockCount += p.blocks.length;
                p.blocks.forEach(b => {
                    hours += (b.analytics||0) + (b.design||0) + (b.frontend||0) + (b.backend||0) + (b.test||0);
                });
            });
            return { hours: Math.round(hours), pages: snapshot.pages.length, blocks: blockCount };
        }

        function updateProjectsCount() {
            const el = document.getElementById('projectsCount');
            if (el) {
                el.textContent = projects.length;
                el.style.background = projects.length > 0 ? '#3B82F6' : '#94A3B8';
            }
        }

        async function loadProjects() {
            try {
                showProjectsLoading(true);
                const rows = await sbFetch('GET', TABLE + '?select=*&order=updated_at.desc');
                projects = (rows || []).map(r => ({
                    id: r.id,
                    name: r.name,
                    createdAt: r.created_at,
                    updatedAt: r.updated_at,
                    snapshot: r.snapshot || {},
                    totals: calcProjectTotals(r.snapshot)
                }));
                updateProjectsCount();
            } catch(e) {
                console.error('loadProjects error:', e);
                showError('Не удалось загрузить проекты.', e.message);
            } finally {
                showProjectsLoading(false);
            }
        }

        async function saveProject() {
            if (isSaving) return;
            if (!currentProjectId) {
                const name = prompt('Название проекта:', 'Новый проект ' + new Date().toLocaleDateString('ru-RU'));
                if (!name) return;
                isSaving = true;
                setSaveBtn('loading');
                try {
                    const snapshot = getStateSnapshot();
                    const rows = await sbFetch('POST', TABLE, {
                        name,
                        snapshot,
                        updated_at: new Date().toISOString()
                    });
                    const row = Array.isArray(rows) ? rows[0] : rows;
                    currentProjectId = row.id;
                    projects.unshift({
                        id: row.id,
                        name: row.name,
                        createdAt: row.created_at,
                        updatedAt: row.updated_at,
                        snapshot,
                        totals: calcProjectTotals(snapshot)
                    });
                    updateProjectsCount();
                    updateCurrentProjectLabel();
                    setSaveBtn('saved');
                } catch(e) {
                    console.error('saveProject error:', e);
                    showError('Ошибка сохранения.', e.message);
                    setSaveBtn('idle');
                } finally {
                    isSaving = false;
                }
            } else {
                isSaving = true;
                setSaveBtn('loading');
                try {
                    const snapshot = getStateSnapshot();
                    const now = new Date().toISOString();
                    await sbFetch('PATCH', TABLE + '?id=eq.' + currentProjectId, {
                        snapshot,
                        updated_at: now
                    });
                    const proj = projects.find(p => p.id === currentProjectId);
                    if (proj) {
                        proj.snapshot = snapshot;
                        proj.updatedAt = now;
                        proj.totals = calcProjectTotals(snapshot);
                    }
                    setSaveBtn('saved');
                } catch(e) {
                    console.error('saveProject error:', e);
                    showError('Ошибка сохранения.', e.message);
                    setSaveBtn('idle');
                } finally {
                    isSaving = false;
                }
            }
        }

        async function createNewProject() {
            const name = prompt('Название нового проекта:', 'Проект ' + (projects.length + 1));
            if (!name) return;

            // Reset calculator state
            state.pages = [];
            state.customWorks = { analytics: [], design: [], frontend: [], backend: [], testing: [], content: [], integrations: [] };
            state.integrations = { crm: false, maps: false, b24: false, hh: false, email: false, metrics: false, chat: false };

            isSaving = true;
            try {
                const snapshot = getStateSnapshot();
                const rows = await sbFetch('POST', TABLE, {
                    name,
                    snapshot,
                    updated_at: new Date().toISOString()
                });
                const row = Array.isArray(rows) ? rows[0] : rows;
                currentProjectId = row.id;
                projects.unshift({
                    id: row.id,
                    name: row.name,
                    createdAt: row.created_at,
                    updatedAt: row.updated_at,
                    snapshot,
                    totals: { hours: 0, pages: 0, blocks: 0 }
                });
                updateProjectsCount();
                switchView('calculator');
                state._skipCalculate = true;
                addPage('Главная страница');
                addPage('О компании');
                state._skipCalculate = false;
                renderPages();
                renderFixedWorks();
                calculateTotals();
                updateCurrentProjectLabel();
            } catch(e) {
                console.error('createNewProject error:', e);
                showError('Ошибка создания проекта.', e.message);
            } finally {
                isSaving = false;
            }
        }

        function openProject(id) {
            const proj = projects.find(p => p.id === id);
            if (!proj) return;
            currentProjectId = id;
            const s = proj.snapshot;
            if (s.pages) state.pages = s.pages;
            if (s.percentages) Object.assign(state.percentages, s.percentages);
            if (s.fixedValues) Object.assign(state.fixedValues, s.fixedValues);
            if (s.integrations) Object.assign(state.integrations, s.integrations);
            if (s.customWorks) Object.keys(s.customWorks).forEach(k => {
                if (Array.isArray(s.customWorks[k])) state.customWorks[k] = s.customWorks[k];
            });
            if (s.disabledWorks) Object.assign(state.disabledWorks, s.disabledWorks);
            if (s.integrationsData) Object.assign(state.integrationsData, s.integrationsData);
            switchView('calculator');
            renderPages();
            renderFixedWorks();
            calculateTotals();
            updateCurrentProjectLabel();
        }

        async function duplicateProject(id) {
            const proj = projects.find(p => p.id === id);
            if (!proj) return;
            const newName = prompt('Название копии:', proj.name + ' (копия)');
            if (!newName) return;
            try {
                const rows = await sbFetch('POST', TABLE, {
                    name: newName,
                    snapshot: proj.snapshot,
                    updated_at: new Date().toISOString()
                });
                const row = Array.isArray(rows) ? rows[0] : rows;
                const newProj = {
                    id: row.id,
                    name: row.name,
                    createdAt: row.created_at,
                    updatedAt: row.updated_at,
                    snapshot: proj.snapshot,
                    totals: proj.totals
                };
                const idx = projects.findIndex(p => p.id === id);
                projects.splice(idx + 1, 0, newProj);
                updateProjectsCount();
                renderProjectsList();
            } catch(e) {
                showError('Ошибка дублирования.', e.message);
            }
        }

        async function deleteProjectById(id) {
            const proj = projects.find(p => p.id === id);
            if (!proj) return;
            if (!confirm('Удалить проект «' + proj.name + '»? Это действие нельзя отменить.')) return;
            try {
                await sbFetch('DELETE', TABLE + '?id=eq.' + id);
                projects = projects.filter(p => p.id !== id);
                if (currentProjectId === id) {
                    currentProjectId = null;
                    updateCurrentProjectLabel();
                }
                updateProjectsCount();
                renderProjectsList();
            } catch(e) {
                showError('Ошибка удаления.', e.message);
            }
        }

        async function renameProject(id, newName) {
            if (!newName.trim()) return;
            const proj = projects.find(p => p.id === id);
            if (!proj) return;
            proj.name = newName.trim();
            proj.updatedAt = new Date().toISOString();
            if (currentProjectId === id) updateCurrentProjectLabel();
            try {
                await sbFetch('PATCH', TABLE + '?id=eq.' + id, {
                    name: newName.trim(),
                    updated_at: proj.updatedAt
                });
            } catch(e) {
                console.error('rename error:', e);
            }
        }

        function exportProjectById(id) {
            const proj = projects.find(p => p.id === id);
            if (!proj) return;
            const savedPages = state.pages;
            const savedPerc = JSON.parse(JSON.stringify(state.percentages));
            const savedFixed = JSON.parse(JSON.stringify(state.fixedValues));
            const savedInt = JSON.parse(JSON.stringify(state.integrations));
            const savedCW = JSON.parse(JSON.stringify(state.customWorks));
            const s = proj.snapshot;
            if (s.pages) state.pages = s.pages;
            if (s.percentages) Object.assign(state.percentages, s.percentages);
            if (s.fixedValues) Object.assign(state.fixedValues, s.fixedValues);
            if (s.integrations) Object.assign(state.integrations, s.integrations);
            if (s.customWorks) Object.keys(s.customWorks).forEach(k => { if (Array.isArray(s.customWorks[k])) state.customWorks[k] = s.customWorks[k]; });
            exportToExcel();
            state.pages = savedPages;
            Object.assign(state.percentages, savedPerc);
            Object.assign(state.fixedValues, savedFixed);
            Object.assign(state.integrations, savedInt);
            Object.assign(state.customWorks, savedCW);
        }

        function updateCurrentProjectLabel() {
            const label = document.getElementById('currentProjectLabel');
            const nameEl = document.getElementById('currentProjectName');
            if (!label || !nameEl) return;
            if (currentProjectId) {
                const proj = projects.find(p => p.id === currentProjectId);
                if (proj) { label.style.display = 'block'; nameEl.textContent = proj.name; return; }
            }
            label.style.display = 'none';
        }

        function switchView(view) {
            const calcView = document.querySelector('.main-content');
            const projView = document.getElementById('projectsView');
            const navCalc = document.getElementById('navCalculator');
            const navProj = document.getElementById('navProjects');
            if (view === 'calculator') {
                calcView.style.display = 'block';
                projView.style.display = 'none';
                navCalc.classList.add('active');
                navProj.classList.remove('active');
            } else {
                calcView.style.display = 'none';
                projView.style.display = 'flex';
                projView.style.flexDirection = 'column';
                navCalc.classList.remove('active');
                navProj.classList.add('active');
                loadProjects().then(() => renderProjectsList());
            }
        }

        function formatDate(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                   ' ' + d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function showProjectsLoading(show) {
            let el = document.getElementById('projectsLoading');
            if (!el) {
                el = document.createElement('div');
                el.id = 'projectsLoading';
                el.style.cssText = 'text-align:center;padding:40px;color:#64748B;font-size:14px;';
                el.innerHTML = '<svg style="animation:spin 1s linear infinite;display:inline-block" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><div style="margin-top:8px;">Загрузка проектов...</div>';
                document.getElementById('projectsList').before(el);
            }
            el.style.display = show ? 'block' : 'none';
        }

        function showError(msg, detail) {
            const el = document.createElement('div');
            el.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#FEE2E2;color:#DC2626;padding:16px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-width:420px;cursor:pointer;';
            el.innerHTML = '⚠️ ' + msg + (detail ? '<div style="margin-top:6px;font-size:12px;font-weight:400;opacity:0.85;word-break:break-all;">' + detail + '</div>' : '');
            el.onclick = () => el.remove();
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 10000);
        }

        function showSuccess(msg) {
            const el = document.createElement('div');
            el.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#DCFCE7;color:#166534;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.1);';
            el.textContent = '✓ ' + msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }

        function setSaveBtn(state) {
            const btn = document.querySelector('button[onclick="saveProject()"]');
            if (!btn) return;
            const icons = {
                idle: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Сохранить',
                loading: '<svg style="animation:spin 1s linear infinite;display:inline-block" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Сохраняю...',
                saved: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Сохранено'
            };
            btn.innerHTML = icons[state];
            if (state === 'saved') {
                btn.style.background = '#10B981';
                setTimeout(() => { btn.innerHTML = icons.idle; btn.style.background = ''; }, 2000);
            } else if (state === 'loading') {
                btn.style.background = '#6B7280';
            }
        }

        function renderProjectsList() {
            const container = document.getElementById('projectsList');
            if (!container) return;
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="projects-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        <h3>Нет сохранённых проектов</h3>
                        <p>Нажмите «Новый проект» чтобы создать первую оценку</p>
                    </div>`;
                return;
            }
            container.innerHTML = projects.map(proj => {
                const isActive = proj.id === currentProjectId;
                const t = proj.totals || { hours: 0, pages: 0, blocks: 0 };
                return `
                <div class="project-card ${isActive ? 'active-project' : ''}">
                    <div class="project-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div class="project-info">
                        <input class="project-name-input" value="${(proj.name||'').replace(/"/g,'&quot;')}"
                            onchange="renameProject(${proj.id}, this.value)"
                            onclick="event.stopPropagation()">
                        <div class="project-meta">
                            <span>Создан: ${formatDate(proj.createdAt)}</span>
                            <span>Изменён: ${formatDate(proj.updatedAt)}</span>
                            ${isActive ? '<span style="color:#3B82F6;font-weight:600;">● Открыт сейчас</span>' : ''}
                        </div>
                    </div>
                    <div class="project-stats">
                        <div class="project-stat">
                            <div class="project-stat-value">${t.pages}</div>
                            <div class="project-stat-label">страниц</div>
                        </div>
                        <div class="project-stat">
                            <div class="project-stat-value">${t.blocks}</div>
                            <div class="project-stat-label">блоков</div>
                        </div>
                        <div class="project-stat">
                            <div class="project-stat-value">${t.hours}</div>
                            <div class="project-stat-label">часов</div>
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-primary" onclick="openProject(${proj.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            Открыть
                        </button>
                        <button class="btn btn-secondary" onclick="exportProjectById(${proj.id})" title="Excel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Excel
                        </button>
                        <button class="btn btn-secondary" onclick="duplicateProject(${proj.id})" title="Дублировать">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>
                        <button class="icon-btn delete" onclick="deleteProjectById(${proj.id})" title="Удалить">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // Export functions
        function exportToExcel() {
            // Calculate all values
            const blocksTotal = { analytics: 0, design: 0, frontend: 0, backend: 0, test: 0 };
            state.pages.forEach(page => {
                page.blocks.forEach(block => {
                    blocksTotal.analytics += block.analytics;
                    blocksTotal.design += block.design;
                    blocksTotal.frontend += block.frontend;
                    blocksTotal.backend += block.backend;
                    blocksTotal.test += block.test;
                });
            });

            // First two pages (main + inner)
            const firstTwo = state.pages.slice(0, 2);
            const firstTwoTotal = { analytics: 0, design: 0, frontend: 0, backend: 0, test: 0 };
            firstTwo.forEach(p => p.blocks.forEach(b => {
                firstTwoTotal.analytics += b.analytics;
                firstTwoTotal.design += b.design;
                firstTwoTotal.frontend += b.frontend;
                firstTwoTotal.backend += b.backend;
                firstTwoTotal.test += b.test;
            }));

            // Rest pages (without first two)
            const restPages = state.pages.slice(2);
            const restTotal = { analytics: 0, design: 0, frontend: 0, backend: 0, test: 0 };
            restPages.forEach(p => p.blocks.forEach(b => {
                restTotal.analytics += b.analytics;
                restTotal.design += b.design;
                restTotal.frontend += b.frontend;
                restTotal.backend += b.backend;
                restTotal.test += b.test;
            }));

            // Fixed works calculations
            const analyticsCuration = blocksTotal.analytics * (state.percentages.analyticsCuration / 100);
            const analyticsOperations = blocksTotal.analytics * (state.percentages.analyticsOperations / 100);
            const analyticsPreparation = blocksTotal.analytics * (state.percentages.analyticsPreparation / 100);
            
            const designOperations = blocksTotal.design * (state.percentages.designOperations / 100);
            const designUIKit = blocksTotal.design * (state.percentages.designUIKit / 100);
            const designUsedBlocks = blocksTotal.design * (state.percentages.designUsedBlocks / 100);
            
            const frontendOperations = blocksTotal.frontend * (state.percentages.frontendOperations / 100);
            const frontendReview = blocksTotal.frontend * (state.percentages.frontendReview / 100);
            const frontendBugs = blocksTotal.frontend * (state.percentages.frontendBugs / 100);
            const frontendIntegration = blocksTotal.frontend * (state.percentages.frontendIntegration / 100);
            
            const backendOperations = blocksTotal.backend * (state.percentages.backendOperations / 100);
            const backendReview = blocksTotal.backend * (state.percentages.backendReview / 100);
            const backendBugs = blocksTotal.backend * (state.percentages.backendBugs / 100);
            
            const testingOperations = blocksTotal.test * (state.percentages.testingOperations / 100);
            const testingProd = blocksTotal.test * (state.percentages.testingProd / 100);

            // Custom works totals
            const customAnalytics = (state.customWorks.analytics || []).reduce((sum, w) => sum + w.hours, 0);
            const customDesign = (state.customWorks.design || []).reduce((sum, w) => sum + w.hours, 0);
            const customFrontend = (state.customWorks.frontend || []).reduce((sum, w) => sum + w.hours, 0);
            const customBackend = (state.customWorks.backend || []).reduce((sum, w) => sum + w.hours, 0);
            const customTesting = (state.customWorks.testing || []).reduce((sum, w) => sum + w.hours, 0);
            const customContent = (state.customWorks.content || []).reduce((sum, w) => sum + w.hours, 0);

            // Build export data
            const data = [
                ['Экспорт калькулятора'],
                ['Структура задач', '', '', 'Наименование задач', 'Трудозатраты в часах'],
                [],
                ['1', 'Планирование', '', '', ''],
                ['1.1', '', 'Предпроектная аналитика', '', Math.round(
                    analyticsCuration + analyticsOperations + 
                    state.fixedValues.analyticsBenchmark + state.fixedValues.analyticsBrief + 
                    state.fixedValues.analyticsRequirements + state.fixedValues.analyticsStructure + 
                    analyticsPreparation + customAnalytics
                )],
                ['1.1.1', '', '', 'Курирование', Math.round(analyticsCuration)],
                ['1.1.2', '', '', 'Операционка', Math.round(analyticsOperations)],
                ['1.1.3', '', '', 'Анализ конкурентного окружения. Бенчмаркинг', Math.round(state.fixedValues.analyticsBenchmark)],
                ['1.1.4', '', '', 'Подготовка брифа и интервьюирование', Math.round(state.fixedValues.analyticsBrief)],
                ['1.1.5', '', '', 'Составление бизнес требований', Math.round(state.fixedValues.analyticsRequirements)],
                ['1.1.6', '', '', 'Составление структуры', Math.round(state.fixedValues.analyticsStructure)],
                ['1.1.7', '', '', 'Подготовка макетов к следующим этапам', Math.round(analyticsPreparation)],
            ];

            // Add custom analytics works
            let analyticsIdx = 8;
            (state.customWorks.analytics || []).forEach((w, i) => {
                data.push(['1.1.' + analyticsIdx, '', '', w.name, Math.round(w.hours)]);
                analyticsIdx++;
            });

            // Проектирование
            data.push([]);
            data.push(['1.2', '', 'Проектирование', '', Math.round(firstTwoTotal.analytics + restTotal.analytics)]);
            data.push(['1.2.1', '', '', 'Прототип главной и одной внутренней', Math.round(firstTwoTotal.analytics)]);
            data.push(['1.2.2', '', '', 'Прототип внутренних страниц', Math.round(restTotal.analytics)]);

            // Дизайн
            const designFixedTotal = designOperations + state.fixedValues.designAnimMain + state.fixedValues.designAnimInner + 
                state.fixedValues.designAdaptMain + state.fixedValues.designAdaptAll + state.fixedValues.designUIKitMain + 
                designUIKit + designUsedBlocks + customDesign;
            
            data.push([]);
            data.push(['1.3', '', 'Дизайн', '', Math.round(firstTwoTotal.design + restTotal.design + designFixedTotal)]);
            data.push(['1.3.1', '', '', 'Дизайн-макет главной и одной внутренней', Math.round(firstTwoTotal.design)]);
            data.push(['1.3.2', '', '', 'Дизайн-макет внутренних страниц', Math.round(restTotal.design)]);
            data.push(['1.3.3', '', '', 'Операционка', Math.round(designOperations)]);
            data.push(['1.3.4', '', '', 'Анимации главной страницы', Math.round(state.fixedValues.designAnimMain)]);
            data.push(['1.3.5', '', '', 'Анимации внутренних страниц', Math.round(state.fixedValues.designAnimInner)]);
            data.push(['1.3.6', '', '', 'Адаптивы (главная и 1 внутренняя)', Math.round(state.fixedValues.designAdaptMain)]);
            data.push(['1.3.7', '', '', 'Адаптивы всех страниц', Math.round(state.fixedValues.designAdaptAll)]);
            data.push(['1.3.8', '', '', 'UI-kit (главная и 1 внутренняя)', Math.round(state.fixedValues.designUIKitMain)]);
            data.push(['1.3.9', '', '', 'UI-kit (общий)', Math.round(designUIKit)]);
            data.push(['1.3.10', '', '', 'Использование готовых блоков', Math.round(designUsedBlocks)]);

            // Add custom design works
            let designIdx = 11;
            (state.customWorks.design || []).forEach((w, i) => {
                data.push(['1.3.' + designIdx, '', '', w.name, Math.round(w.hours)]);
                designIdx++;
            });

            // Front-end
            const frontendFixedTotal = state.fixedValues.frontendSetup + state.fixedValues.frontendPrototypes + 
                frontendOperations + frontendReview + frontendBugs + 
                state.fixedValues.frontendAnimMain + state.fixedValues.frontendAnimInner + 
                frontendIntegration + customFrontend;
            
            data.push([]);
            data.push(['1.4', '', 'Front-end', '', Math.round(firstTwoTotal.frontend + restTotal.frontend + frontendFixedTotal)]);
            data.push(['1.4.1', '', '', 'Front-end главной и одной внутренней', Math.round(firstTwoTotal.frontend)]);
            data.push(['1.4.2', '', '', 'Front-end внутренних страниц', Math.round(restTotal.frontend)]);
            data.push(['1.4.3', '', '', 'Разворачивание проекта', Math.round(state.fixedValues.frontendSetup)]);
            data.push(['1.4.4', '', '', 'Оценка прототипов', Math.round(state.fixedValues.frontendPrototypes)]);
            data.push(['1.4.5', '', '', 'Операционка', Math.round(frontendOperations)]);
            data.push(['1.4.6', '', '', 'Ревью и курирование', Math.round(frontendReview)]);
            data.push(['1.4.7', '', '', 'Правка багов', Math.round(frontendBugs)]);
            data.push(['1.4.8', '', '', 'Анимации главной страницы', Math.round(state.fixedValues.frontendAnimMain)]);
            data.push(['1.4.9', '', '', 'Анимации внутренних страниц', Math.round(state.fixedValues.frontendAnimInner)]);
            data.push(['1.4.10', '', '', 'Интеграции front и back', Math.round(frontendIntegration)]);

            // Add custom frontend works
            let frontendIdx = 11;
            (state.customWorks.frontend || []).forEach((w, i) => {
                data.push(['1.4.' + frontendIdx, '', '', w.name, Math.round(w.hours)]);
                frontendIdx++;
            });

            // Back-end
            const backendFixedTotal = state.fixedValues.backendSetup + backendOperations + backendReview + backendBugs + 
                state.fixedValues.backendMultilang + state.fixedValues.backendMultilangFront + 
                state.fixedValues.backendSearch + state.fixedValues.backendSearchFront + customBackend;
            
            data.push([]);
            data.push(['1.5', '', 'Back-end', '', Math.round(firstTwoTotal.backend + restTotal.backend + backendFixedTotal)]);
            data.push(['1.5.1', '', '', 'Back-end главной и одной внутренней', Math.round(firstTwoTotal.backend)]);
            data.push(['1.5.2', '', '', 'Back-end внутренних страниц', Math.round(restTotal.backend)]);
            data.push(['1.5.3', '', '', 'Разворачивание проекта', Math.round(state.fixedValues.backendSetup)]);
            data.push(['1.5.4', '', '', 'Операционка', Math.round(backendOperations)]);
            data.push(['1.5.5', '', '', 'Ревью и курирование', Math.round(backendReview)]);
            data.push(['1.5.6', '', '', 'Правка багов', Math.round(backendBugs)]);
            data.push(['1.5.7', '', '', 'Мультиязычность', Math.round(state.fixedValues.backendMultilang + state.fixedValues.backendMultilangFront)]);
            data.push(['1.5.8', '', '', 'Базовый Поиск', Math.round(state.fixedValues.backendSearch + state.fixedValues.backendSearchFront)]);

            // Add custom backend works
            let backendIdx = 9;
            (state.customWorks.backend || []).forEach((w, i) => {
                data.push(['1.5.' + backendIdx, '', '', w.name, Math.round(w.hours)]);
                backendIdx++;
            });

            // Тестирование
            const testingFixedTotal = testingOperations + testingProd + 
                state.fixedValues.testingArtifacts + state.fixedValues.testingPrototypes + 
                state.fixedValues.testingDesign + state.fixedValues.testingPerformance + 
                state.fixedValues.testingContent + customTesting;
            
            data.push([]);
            data.push(['1.6', '', 'Тестирование', '', Math.round(firstTwoTotal.test + restTotal.test + testingFixedTotal)]);
            data.push(['1.6.1', '', '', 'Тестирование главной и одной внутренней', Math.round(firstTwoTotal.test)]);
            data.push(['1.6.2', '', '', 'Тестирование внутренних страниц', Math.round(restTotal.test)]);
            data.push(['1.6.3', '', '', 'Операционка', Math.round(testingOperations)]);
            data.push(['1.6.4', '', '', 'Тестирование на проде', Math.round(testingProd)]);
            data.push(['1.6.5', '', '', 'Отсмотр артефактов с аналитики', Math.round(state.fixedValues.testingArtifacts)]);
            data.push(['1.6.6', '', '', 'Отсмотр прототипов', Math.round(state.fixedValues.testingPrototypes)]);
            data.push(['1.6.7', '', '', 'Отсмотр дизайн-макетов', Math.round(state.fixedValues.testingDesign)]);
            data.push(['1.6.8', '', '', 'Тестирование производительности', Math.round(state.fixedValues.testingPerformance)]);
            data.push(['1.6.9', '', '', 'Тестирование с контентом', Math.round(state.fixedValues.testingContent)]);

            // Add custom testing works
            let testingIdx = 10;
            (state.customWorks.testing || []).forEach((w, i) => {
                data.push(['1.6.' + testingIdx, '', '', w.name, Math.round(w.hours)]);
                testingIdx++;
            });

            // Контент
            data.push([]);
            data.push(['1.7', '', 'Контент', '', Math.round(state.fixedValues.contentFill + state.fixedValues.contentInstruction + customContent)]);
            data.push(['1.7.1', '', '', 'Наполнение контентом', Math.round(state.fixedValues.contentFill)]);
            data.push(['1.7.2', '', '', 'Инструкция для контент-менеджера', Math.round(state.fixedValues.contentInstruction)]);

            // Add custom content works
            let contentIdx = 3;
            (state.customWorks.content || []).forEach((w, i) => {
                data.push(['1.7.' + contentIdx, '', '', w.name, Math.round(w.hours)]);
                contentIdx++;
            });

            // Create workbook and export
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 10 },  // A
                { wch: 15 },  // B
                { wch: 25 },  // C
                { wch: 45 },  // D
                { wch: 20 }   // E
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Оценка');
            XLSX.writeFile(wb, 'calculator-export.xlsx');
        }

        // GanttPro API URL - замените на ваш URL после деплоя на Vercel
        const GANTTPRO_API_URL = localStorage.getItem('ganttproApiUrl') || '';

        async function exportToGanttPro() {
            if (!GANTTPRO_API_URL) {
                const url = prompt('Введите URL вашего Vercel сервиса (например: https://your-project.vercel.app):\n\nЭто нужно сделать только один раз.');
                if (url) {
                    localStorage.setItem('ganttproApiUrl', url);
                    location.reload();
                }
                return;
            }

            const projectName = prompt('Введите название проекта для GanttPro:', 'Новый проект ' + new Date().toLocaleDateString('ru-RU'));
            if (!projectName) return;

            // Собираем все данные для выгрузки
            const tasks = [];

            // Calculate totals for percentage-based works
            const blocksTotal = { analytics: 0, design: 0, frontend: 0, backend: 0, test: 0 };
            state.pages.forEach(page => {
                page.blocks.forEach(block => {
                    blocksTotal.analytics += block.analytics;
                    blocksTotal.design += block.design;
                    blocksTotal.frontend += block.frontend;
                    blocksTotal.backend += block.backend;
                    blocksTotal.test += block.test;
                });
            });

            // Helper to check if work is disabled
            const isDisabled = (type, key) => state.disabledWorks[type]?.includes(key);

            // 1. Аналитика
            tasks.push({ name: '1. Предпроектная аналитика', hours: 0, isSection: true });
            
            if (!isDisabled('percentages', 'analyticsCuration')) {
                tasks.push({ name: 'Курирование', hours: Math.round(blocksTotal.analytics * state.percentages.analyticsCuration / 100), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('percentages', 'analyticsOperations')) {
                tasks.push({ name: 'Операционка', hours: Math.round(blocksTotal.analytics * state.percentages.analyticsOperations / 100), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('fixed', 'analyticsBenchmark')) {
                tasks.push({ name: 'Анализ конкурентного окружения', hours: Math.round(state.fixedValues.analyticsBenchmark), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('fixed', 'analyticsBrief')) {
                tasks.push({ name: 'Подготовка брифа', hours: Math.round(state.fixedValues.analyticsBrief), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('fixed', 'analyticsRequirements')) {
                tasks.push({ name: 'Составление бизнес требований', hours: Math.round(state.fixedValues.analyticsRequirements), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('fixed', 'analyticsStructure')) {
                tasks.push({ name: 'Составление структуры', hours: Math.round(state.fixedValues.analyticsStructure), parentSection: '1. Предпроектная аналитика' });
            }
            if (!isDisabled('percentages', 'analyticsPreparation')) {
                tasks.push({ name: 'Подготовка макетов к этапам', hours: Math.round(blocksTotal.analytics * state.percentages.analyticsPreparation / 100), parentSection: '1. Предпроектная аналитика' });
            }

            // 2. Проектирование
            const firstTwo = state.pages.slice(0, 2);
            const restPages = state.pages.slice(2);
            let firstTwoAnalytics = 0, restAnalytics = 0;
            firstTwo.forEach(p => p.blocks.forEach(b => firstTwoAnalytics += b.analytics));
            restPages.forEach(p => p.blocks.forEach(b => restAnalytics += b.analytics));

            tasks.push({ name: '2. Проектирование', hours: 0, isSection: true });
            tasks.push({ name: 'Прототип главной и одной внутренней', hours: Math.round(firstTwoAnalytics), parentSection: '2. Проектирование' });
            if (restAnalytics > 0) {
                tasks.push({ name: 'Прототип внутренних страниц', hours: Math.round(restAnalytics), parentSection: '2. Проектирование' });
            }

            // 3. Дизайн
            let firstTwoDesign = 0, restDesign = 0;
            firstTwo.forEach(p => p.blocks.forEach(b => firstTwoDesign += b.design));
            restPages.forEach(p => p.blocks.forEach(b => restDesign += b.design));

            tasks.push({ name: '3. Дизайн', hours: 0, isSection: true });
            tasks.push({ name: 'Дизайн главной и одной внутренней', hours: Math.round(firstTwoDesign), parentSection: '3. Дизайн' });
            if (restDesign > 0) {
                tasks.push({ name: 'Дизайн внутренних страниц', hours: Math.round(restDesign), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('percentages', 'designOperations')) {
                tasks.push({ name: 'Операционка', hours: Math.round(blocksTotal.design * state.percentages.designOperations / 100), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('fixed', 'designAnimMain')) {
                tasks.push({ name: 'Анимации главной', hours: Math.round(state.fixedValues.designAnimMain), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('fixed', 'designAnimInner')) {
                tasks.push({ name: 'Анимации внутренних', hours: Math.round(state.fixedValues.designAnimInner), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('fixed', 'designAdaptMain')) {
                tasks.push({ name: 'Адаптивы (главная и 1 внутр)', hours: Math.round(state.fixedValues.designAdaptMain), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('fixed', 'designAdaptAll')) {
                tasks.push({ name: 'Адаптивы всех страниц', hours: Math.round(state.fixedValues.designAdaptAll), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('fixed', 'designUIKitMain')) {
                tasks.push({ name: 'UI-kit (главная и 1 внутр)', hours: Math.round(state.fixedValues.designUIKitMain), parentSection: '3. Дизайн' });
            }
            if (!isDisabled('percentages', 'designUIKit')) {
                tasks.push({ name: 'UI-kit (общий)', hours: Math.round(blocksTotal.design * state.percentages.designUIKit / 100), parentSection: '3. Дизайн' });
            }

            // 4. Frontend
            let firstTwoFrontend = 0, restFrontend = 0;
            firstTwo.forEach(p => p.blocks.forEach(b => firstTwoFrontend += b.frontend));
            restPages.forEach(p => p.blocks.forEach(b => restFrontend += b.frontend));

            tasks.push({ name: '4. Front-end', hours: 0, isSection: true });
            tasks.push({ name: 'Front-end главной и одной внутренней', hours: Math.round(firstTwoFrontend), parentSection: '4. Front-end' });
            if (restFrontend > 0) {
                tasks.push({ name: 'Front-end внутренних страниц', hours: Math.round(restFrontend), parentSection: '4. Front-end' });
            }
            if (!isDisabled('fixed', 'frontendSetup')) {
                tasks.push({ name: 'Разворачивание проекта', hours: Math.round(state.fixedValues.frontendSetup), parentSection: '4. Front-end' });
            }
            if (!isDisabled('fixed', 'frontendPrototypes')) {
                tasks.push({ name: 'Оценка прототипов', hours: Math.round(state.fixedValues.frontendPrototypes), parentSection: '4. Front-end' });
            }
            if (!isDisabled('percentages', 'frontendOperations')) {
                tasks.push({ name: 'Операционка', hours: Math.round(blocksTotal.frontend * state.percentages.frontendOperations / 100), parentSection: '4. Front-end' });
            }
            if (!isDisabled('percentages', 'frontendReview')) {
                tasks.push({ name: 'Ревью и курирование', hours: Math.round(blocksTotal.frontend * state.percentages.frontendReview / 100), parentSection: '4. Front-end' });
            }
            if (!isDisabled('percentages', 'frontendBugs')) {
                tasks.push({ name: 'Правка багов', hours: Math.round(blocksTotal.frontend * state.percentages.frontendBugs / 100), parentSection: '4. Front-end' });
            }
            if (!isDisabled('fixed', 'frontendAnimMain')) {
                tasks.push({ name: 'Анимации главной', hours: Math.round(state.fixedValues.frontendAnimMain), parentSection: '4. Front-end' });
            }
            if (!isDisabled('fixed', 'frontendAnimInner')) {
                tasks.push({ name: 'Анимации внутренних', hours: Math.round(state.fixedValues.frontendAnimInner), parentSection: '4. Front-end' });
            }

            // 5. Backend
            let firstTwoBackend = 0, restBackend = 0;
            firstTwo.forEach(p => p.blocks.forEach(b => firstTwoBackend += b.backend));
            restPages.forEach(p => p.blocks.forEach(b => restBackend += b.backend));

            tasks.push({ name: '5. Back-end', hours: 0, isSection: true });
            tasks.push({ name: 'Back-end главной и одной внутренней', hours: Math.round(firstTwoBackend), parentSection: '5. Back-end' });
            if (restBackend > 0) {
                tasks.push({ name: 'Back-end внутренних страниц', hours: Math.round(restBackend), parentSection: '5. Back-end' });
            }
            if (!isDisabled('fixed', 'backendSetup')) {
                tasks.push({ name: 'Разворачивание проекта', hours: Math.round(state.fixedValues.backendSetup), parentSection: '5. Back-end' });
            }
            if (!isDisabled('percentages', 'backendOperations')) {
                tasks.push({ name: 'Операционка', hours: Math.round(blocksTotal.backend * state.percentages.backendOperations / 100), parentSection: '5. Back-end' });
            }
            if (!isDisabled('percentages', 'backendReview')) {
                tasks.push({ name: 'Ревью и курирование', hours: Math.round(blocksTotal.backend * state.percentages.backendReview / 100), parentSection: '5. Back-end' });
            }
            if (!isDisabled('percentages', 'backendBugs')) {
                tasks.push({ name: 'Правка багов', hours: Math.round(blocksTotal.backend * state.percentages.backendBugs / 100), parentSection: '5. Back-end' });
            }
            if (!isDisabled('fixed', 'backendMultilang')) {
                tasks.push({ name: 'Мультиязычность', hours: Math.round(state.fixedValues.backendMultilang + state.fixedValues.backendMultilangFront), parentSection: '5. Back-end' });
            }
            if (!isDisabled('fixed', 'backendSearch')) {
                tasks.push({ name: 'Базовый поиск', hours: Math.round(state.fixedValues.backendSearch + state.fixedValues.backendSearchFront), parentSection: '5. Back-end' });
            }

            // 6. Тестирование
            let firstTwoTest = 0, restTest = 0;
            firstTwo.forEach(p => p.blocks.forEach(b => firstTwoTest += b.test));
            restPages.forEach(p => p.blocks.forEach(b => restTest += b.test));

            tasks.push({ name: '6. Тестирование', hours: 0, isSection: true });
            tasks.push({ name: 'Тестирование главной и одной внутренней', hours: Math.round(firstTwoTest), parentSection: '6. Тестирование' });
            if (restTest > 0) {
                tasks.push({ name: 'Тестирование внутренних страниц', hours: Math.round(restTest), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('percentages', 'testingOperations')) {
                tasks.push({ name: 'Операционка', hours: Math.round(blocksTotal.test * state.percentages.testingOperations / 100), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('percentages', 'testingProd')) {
                tasks.push({ name: 'Тестирование на проде', hours: Math.round(blocksTotal.test * state.percentages.testingProd / 100), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('fixed', 'testingArtifacts')) {
                tasks.push({ name: 'Отсмотр артефактов', hours: Math.round(state.fixedValues.testingArtifacts), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('fixed', 'testingPrototypes')) {
                tasks.push({ name: 'Отсмотр прототипов', hours: Math.round(state.fixedValues.testingPrototypes), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('fixed', 'testingDesign')) {
                tasks.push({ name: 'Отсмотр дизайн-макетов', hours: Math.round(state.fixedValues.testingDesign), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('fixed', 'testingPerformance')) {
                tasks.push({ name: 'Тестирование производительности', hours: Math.round(state.fixedValues.testingPerformance), parentSection: '6. Тестирование' });
            }
            if (!isDisabled('fixed', 'testingContent')) {
                tasks.push({ name: 'Тестирование с контентом', hours: Math.round(state.fixedValues.testingContent), parentSection: '6. Тестирование' });
            }

            // 7. Контент
            tasks.push({ name: '7. Контент', hours: 0, isSection: true });
            if (!isDisabled('fixed', 'contentFill')) {
                tasks.push({ name: 'Наполнение контентом', hours: Math.round(state.fixedValues.contentFill), parentSection: '7. Контент' });
            }
            if (!isDisabled('fixed', 'contentInstruction')) {
                tasks.push({ name: 'Инструкция для контент-менеджера', hours: Math.round(state.fixedValues.contentInstruction), parentSection: '7. Контент' });
            }
            if (!isDisabled('fixed', 'contentTZ')) {
                tasks.push({ name: 'Написание ТЗ', hours: Math.round(state.fixedValues.contentTZ), parentSection: '7. Контент' });
            }

            // Отправляем на сервер
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Отправка...';

                const response = await fetch(GANTTPRO_API_URL + '/api/ganttpro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, tasks })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`✅ Проект "${projectName}" успешно создан в GanttPro!\n\nСоздано задач: ${result.tasksCreated}`);
                } else {
                    alert('❌ Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }

                btn.disabled = false;
                btn.textContent = 'GanttPro';
            } catch (error) {
                alert('❌ Ошибка подключения: ' + error.message + '\n\nПроверьте URL сервера.');
                event.target.disabled = false;
                event.target.textContent = 'GanttPro';
            }
        }

        // ==================== ADMIN PANEL FUNCTIONS ====================
        
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderAdminPanel();
            }
        }

        function renderAdminPanel() {
            const container = document.getElementById('adminBody');
            const difficultyLabels = {
                easy: 'Лёгкие блоки',
                medium: 'Средние блоки',
                hard: 'Сложные блоки'
            };

            let html = '';

            ['easy', 'medium', 'hard'].forEach(difficulty => {
                html += `
                    <div class="admin-section">
                        <div class="admin-section-title ${difficulty}">${difficultyLabels[difficulty]}</div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Название блока</th>
                                    <th style="width: 90px;">Аналитика</th>
                                    <th style="width: 90px;">Дизайн</th>
                                    <th style="width: 90px;">Front-end</th>
                                    <th style="width: 90px;">Back-end</th>
                                    <th style="width: 90px;">Test</th>
                                    <th style="width: 90px;">Итого</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${blocks[difficulty].map((block, index) => {
                                    const total = block.analytics + block.design + block.frontend + block.backend + block.test;
                                    return `
                                        <tr>
                                            <td>
                                                <button class="delete-block-btn" onclick="deleteAdminBlock('${difficulty}', ${index})" title="Удалить блок">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                </button>
                                            </td>
                                            <td class="block-name">
                                                <input type="text" value="${block.name}" style="width: 100%; min-width: 200px;" 
                                                    onchange="updateBlockName('${difficulty}', ${index}, this.value)">
                                            </td>
                                            <td><input type="number" step="0.1" value="${block.analytics}" onchange="updateBlockValue('${difficulty}', ${index}, 'analytics', this.value)"></td>
                                            <td><input type="number" step="0.1" value="${block.design}" onchange="updateBlockValue('${difficulty}', ${index}, 'design', this.value)"></td>
                                            <td><input type="number" step="0.1" value="${block.frontend}" onchange="updateBlockValue('${difficulty}', ${index}, 'frontend', this.value)"></td>
                                            <td><input type="number" step="0.1" value="${block.backend}" onchange="updateBlockValue('${difficulty}', ${index}, 'backend', this.value)"></td>
                                            <td><input type="number" step="0.1" value="${block.test}" onchange="updateBlockValue('${difficulty}', ${index}, 'test', this.value)"></td>
                                            <td class="total-cell" id="total-${difficulty}-${index}">${total.toFixed(0)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <div class="admin-add-block">
                            <input type="text" id="newBlockName-${difficulty}" placeholder="Название нового блока...">
                            <button class="btn btn-secondary" onclick="addNewBlock('${difficulty}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Добавить блок
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function deleteAdminBlock(difficulty, index) {
            if (confirm('Удалить этот блок?')) {
                blocks[difficulty].splice(index, 1);
                renderAdminPanel();
            }
        }

        function updateBlockName(difficulty, index, value) {
            blocks[difficulty][index].name = value;
        }

        function updateBlockValue(difficulty, index, field, value) {
            blocks[difficulty][index][field] = parseFloat(value) || 0;
            // Update total
            const block = blocks[difficulty][index];
            const total = block.analytics + block.design + block.frontend + block.backend + block.test;
            document.getElementById(`total-${difficulty}-${index}`).textContent = total.toFixed(0);
        }



        function addNewBlock(difficulty) {
            const nameInput = document.getElementById(`newBlockName-${difficulty}`);
            const name = nameInput.value.trim();
            if (!name) {
                alert('Введите название блока');
                return;
            }
            blocks[difficulty].push({
                name: name,
                analytics: 0,
                design: 0,
                frontend: 0,
                backend: 0,
                test: 0
            });
            nameInput.value = '';
            renderAdminPanel();
        }

        function saveBlocksData() {
            try {
                localStorage.setItem('calculatorBlocks', JSON.stringify(blocks));
                alert('Изменения сохранены!');
                // Re-render blocks list in modal
                renderBlocksList();
            } catch (e) {
                alert('Ошибка сохранения: ' + e.message);
            }
        }

        function resetBlocksData() {
            if (confirm('Сбросить все блоки к исходным значениям? Это действие нельзя отменить.')) {
                blocks = JSON.parse(JSON.stringify(defaultBlocks));
                localStorage.removeItem('calculatorBlocks');
                renderAdminPanel();
                renderBlocksList();
                alert('Блоки сброшены к исходным значениям');
            }
        }

        // Close admin panel on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const panel = document.getElementById('adminPanel');
                if (panel.classList.contains('active')) {
                    toggleAdminPanel();
                }
            }
        });

        // Close admin panel on click outside
        document.getElementById('adminPanel').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleAdminPanel();
            }
        });

        // ==================== WORKS ADMIN PANEL FUNCTIONS ====================

        function toggleWorksAdminPanel() {
            const panel = document.getElementById('worksAdminPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderWorksAdminPanel();
            }
        }

        function renderWorksAdminPanel() {
            const container = document.getElementById('worksAdminBody');
            
            const sections = [
                {
                    title: 'Работы по аналитике',
                    color: 'easy',
                    percentages: [
                        { key: 'analyticsCuration', name: 'Курирование', hint: '% от суммы блоков' },
                        { key: 'analyticsOperations', name: 'Операционка', hint: '% от суммы блоков' },
                        { key: 'analyticsPreparation', name: 'Подготовка макетов к этапам', hint: '% от суммы блоков' }
                    ],
                    fixed: [
                        { key: 'analyticsBenchmark', name: 'Анализ конкурентного окружения' },
                        { key: 'analyticsBrief', name: 'Подготовка брифа' },
                        { key: 'analyticsRequirements', name: 'Составление бизнес требований' },
                        { key: 'analyticsStructure', name: 'Составление структуры' }
                    ]
                },
                {
                    title: 'Работы по дизайну',
                    color: 'easy',
                    percentages: [
                        { key: 'designOperations', name: 'Операционка', hint: '% от суммы блоков' },
                        { key: 'designUIKit', name: 'UI-kit (общий)', hint: '% от суммы блоков' },
                        { key: 'designUsedBlocks', name: 'Использование готовых блоков', hint: '% скидка' },
                        { key: 'designSupervision', name: 'Авторский надзор', hint: '% от итого' }
                    ],
                    fixed: [
                        { key: 'designAnimMain', name: 'Анимации главной' },
                        { key: 'designAnimInner', name: 'Анимация внутренних' },
                        { key: 'designAdaptMain', name: 'Адаптивы (главной и 1 внутр)' },
                        { key: 'designAdaptAll', name: 'Адаптивы всех страниц' },
                        { key: 'designUIKitMain', name: 'UI-kit (главной и 1 внутр)' }
                    ]
                },
                {
                    title: 'Работы по Front-end',
                    color: 'medium',
                    percentages: [
                        { key: 'frontendOperations', name: 'Операционка', hint: '% от суммы блоков' },
                        { key: 'frontendReview', name: 'Ревью и курирование', hint: '% от суммы блоков' },
                        { key: 'frontendBugs', name: 'Правка багов', hint: '% от суммы блоков' },
                        { key: 'frontendIntegration', name: 'Интеграции front и back', hint: '% от суммы блоков' }
                    ],
                    fixed: [
                        { key: 'frontendSetup', name: 'Разворачивание проекта' },
                        { key: 'frontendPrototypes', name: 'Оценка прототипов' },
                        { key: 'frontendAnimMain', name: 'Анимации главной страницы' },
                        { key: 'frontendAnimInner', name: 'Анимации внутренних страниц' }
                    ]
                },
                {
                    title: 'Работы по Back-end',
                    color: 'medium',
                    percentages: [
                        { key: 'backendOperations', name: 'Операционка', hint: '% от суммы блоков' },
                        { key: 'backendReview', name: 'Ревью и курирование', hint: '% от суммы блоков' },
                        { key: 'backendBugs', name: 'Правка багов', hint: '% от суммы блоков' }
                    ],
                    fixed: [
                        { key: 'backendSetup', name: 'Разворачивание проекта' },
                        { key: 'backendMultilang', name: 'Мультиязычность (backend)' },
                        { key: 'backendMultilangFront', name: 'Мультиязычность (frontend)' },
                        { key: 'backendSearch', name: 'Базовый Поиск (backend)' },
                        { key: 'backendSearchFront', name: 'Базовый Поиск (frontend)' }
                    ]
                },
                {
                    title: 'Работы по тестированию',
                    color: 'hard',
                    percentages: [
                        { key: 'testingOperations', name: 'Операционка', hint: '% от суммы блоков' },
                        { key: 'testingProd', name: 'Тестирование на проде', hint: '% от суммы блоков' }
                    ],
                    fixed: [
                        { key: 'testingArtifacts', name: 'Отсмотр артефактов с аналитики' },
                        { key: 'testingPrototypes', name: 'Отсмотр прототипов' },
                        { key: 'testingDesign', name: 'Отсмотр дизайн-макетов' },
                        { key: 'testingPerformance', name: 'Тестирование производительности' },
                        { key: 'testingContent', name: 'Тестирование с контентом' }
                    ]
                },
                {
                    title: 'Работы по контенту',
                    color: 'hard',
                    percentages: [],
                    fixed: [
                        { key: 'contentFill', name: 'Наполнение контентом' },
                        { key: 'contentInstruction', name: 'Инструкция для контент-менеджера' },
                        { key: 'contentTZ', name: 'Написание ТЗ' }
                    ]
                }
            ];

            let html = '';

            sections.forEach(section => {
                html += `
                    <div class="admin-section">
                        <div class="admin-section-title ${section.color}">${section.title}</div>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Название работы</th>
                                    <th style="width: 120px;">Тип</th>
                                    <th style="width: 120px;">Значение</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Percentage works
                section.percentages.forEach(item => {
                    const isDisabled = state.disabledWorks.percentages.includes(item.key);
                    if (!isDisabled) {
                        html += `
                            <tr>
                                <td>
                                    <button class="delete-block-btn" onclick="disableWork('percentages', '${item.key}')" title="Удалить работу">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    </button>
                                </td>
                                <td class="block-name">${item.name} <span style="color: #94A3B8; font-size: 12px;">(${item.hint})</span></td>
                                <td style="color: #3B82F6; font-weight: 500;">Процент</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" step="1" value="${state.percentages[item.key]}" 
                                            onchange="updateWorksPercentage('${item.key}', this.value)">
                                        <span style="color: #64748B;">%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });

                // Fixed hours works
                section.fixed.forEach(item => {
                    const isDisabled = state.disabledWorks.fixed.includes(item.key);
                    if (!isDisabled) {
                        html += `
                            <tr>
                                <td>
                                    <button class="delete-block-btn" onclick="disableWork('fixed', '${item.key}')" title="Удалить работу">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    </button>
                                </td>
                                <td class="block-name">${item.name}</td>
                                <td style="color: #10B981; font-weight: 500;">Фикс. часы</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" step="1" value="${state.fixedValues[item.key]}" 
                                            onchange="updateWorksFixed('${item.key}', this.value)">
                                        <span style="color: #64748B;">ч</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Integrations section
            html += `
                <div class="admin-section">
                    <div class="admin-section-title medium">Интеграции (часы по направлениям)</div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Интеграция</th>
                                <th style="width: 90px;">Аналитика</th>
                                <th style="width: 90px;">Дизайн</th>
                                <th style="width: 90px;">Frontend</th>
                                <th style="width: 90px;">Backend</th>
                                <th style="width: 90px;">Test</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const integrationNames = {
                crm: 'CRM',
                maps: 'Карты',
                b24: 'Битрикс24',
                hh: 'HeadHunter',
                email: 'Email-маркетинг',
                metrics: 'Метрика',
                chat: 'Чат'
            };

            Object.keys(state.integrationsData).forEach(key => {
                const isDisabled = state.disabledWorks.integrations.includes(key);
                if (!isDisabled) {
                    const intg = state.integrationsData[key];
                    html += `
                        <tr>
                            <td>
                                <button class="delete-block-btn" onclick="disableWork('integrations', '${key}')" title="Удалить интеграцию">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </td>
                            <td class="block-name">${integrationNames[key]}</td>
                            <td><input type="number" step="0.1" value="${intg.analytics}" onchange="updateIntegrationValue('${key}', 'analytics', this.value)"></td>
                            <td><input type="number" step="0.1" value="${intg.design}" onchange="updateIntegrationValue('${key}', 'design', this.value)"></td>
                            <td><input type="number" step="0.1" value="${intg.frontend}" onchange="updateIntegrationValue('${key}', 'frontend', this.value)"></td>
                            <td><input type="number" step="0.1" value="${intg.backend}" onchange="updateIntegrationValue('${key}', 'backend', this.value)"></td>
                            <td><input type="number" step="0.1" value="${intg.test}" onchange="updateIntegrationValue('${key}', 'test', this.value)"></td>
                        </tr>
                    `;
                }
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Disabled works section (to restore)
            const hasDisabled = state.disabledWorks.percentages.length > 0 || 
                               state.disabledWorks.fixed.length > 0 || 
                               state.disabledWorks.integrations.length > 0;
            
            if (hasDisabled) {
                html += `
                    <div class="admin-section">
                        <div class="admin-section-title" style="background: #F1F5F9; color: #64748B;">Удалённые работы (нажмите чтобы восстановить)</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px;">
                `;
                
                // Get all work names for display
                const allWorks = {
                    percentages: {
                        analyticsCuration: 'Курирование', analyticsOperations: 'Операционка (аналитика)', 
                        analyticsPreparation: 'Подготовка макетов', designOperations: 'Операционка (дизайн)',
                        designUIKit: 'UI-kit (общий)', designUsedBlocks: 'Готовые блоки', designSupervision: 'Авторский надзор',
                        frontendOperations: 'Операционка (frontend)', frontendReview: 'Ревью (frontend)',
                        frontendBugs: 'Правка багов (frontend)', frontendIntegration: 'Интеграции front/back',
                        backendOperations: 'Операционка (backend)', backendReview: 'Ревью (backend)', backendBugs: 'Правка багов (backend)',
                        testingOperations: 'Операционка (тест)', testingProd: 'Тестирование на проде'
                    },
                    fixed: {
                        analyticsBenchmark: 'Анализ конкурентов', analyticsBrief: 'Подготовка брифа',
                        analyticsRequirements: 'Бизнес требования', analyticsStructure: 'Составление структуры',
                        designAnimMain: 'Анимации главной', designAnimInner: 'Анимации внутренних',
                        designAdaptMain: 'Адаптивы (главная)', designAdaptAll: 'Адаптивы всех страниц', designUIKitMain: 'UI-kit (главная)',
                        frontendSetup: 'Разворачивание (frontend)', frontendPrototypes: 'Оценка прототипов',
                        frontendAnimMain: 'Анимации главной (frontend)', frontendAnimInner: 'Анимации внутренних (frontend)',
                        backendSetup: 'Разворачивание (backend)', backendMultilang: 'Мультиязычность (back)',
                        backendMultilangFront: 'Мультиязычность (front)', backendSearch: 'Поиск (back)', backendSearchFront: 'Поиск (front)',
                        testingArtifacts: 'Отсмотр артефактов', testingPrototypes: 'Отсмотр прототипов',
                        testingDesign: 'Отсмотр макетов', testingPerformance: 'Тест производительности', testingContent: 'Тест с контентом',
                        contentFill: 'Наполнение контентом', contentInstruction: 'Инструкция', contentTZ: 'Написание ТЗ'
                    },
                    integrations: integrationNames
                };

                state.disabledWorks.percentages.forEach(key => {
                    html += `<button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="restoreWork('percentages', '${key}')">${allWorks.percentages[key] || key}</button>`;
                });
                state.disabledWorks.fixed.forEach(key => {
                    html += `<button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="restoreWork('fixed', '${key}')">${allWorks.fixed[key] || key}</button>`;
                });
                state.disabledWorks.integrations.forEach(key => {
                    html += `<button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="restoreWork('integrations', '${key}')">${allWorks.integrations[key] || key}</button>`;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function updateWorksPercentage(key, value) {
            state.percentages[key] = parseFloat(value) || 0;
        }

        function updateWorksFixed(key, value) {
            state.fixedValues[key] = parseFloat(value) || 0;
        }

        function updateIntegrationValue(integration, field, value) {
            state.integrationsData[integration][field] = parseFloat(value) || 0;
        }

        function disableWork(type, key) {
            if (!state.disabledWorks[type].includes(key)) {
                state.disabledWorks[type].push(key);
                renderWorksAdminPanel();
            }
        }

        function disableWorkMain(type, key) {
            if (!state.disabledWorks[type].includes(key)) {
                state.disabledWorks[type].push(key);
                localStorage.setItem('calculatorDisabledWorks', JSON.stringify(state.disabledWorks));
                renderFixedWorks();
                calculateTotals();
                saveState();
            }
        }

        function restoreWork(type, key) {
            const index = state.disabledWorks[type].indexOf(key);
            if (index > -1) {
                state.disabledWorks[type].splice(index, 1);
                renderWorksAdminPanel();
            }
        }

        function saveWorksData() {
            try {
                localStorage.setItem('calculatorPercentages', JSON.stringify(state.percentages));
                localStorage.setItem('calculatorFixedValues', JSON.stringify(state.fixedValues));
                localStorage.setItem('calculatorIntegrationsData', JSON.stringify(state.integrationsData));
                localStorage.setItem('calculatorDisabledWorks', JSON.stringify(state.disabledWorks));
                
                // Re-render fixed works and recalculate
                renderFixedWorks();
                calculateTotals();
                saveState();
                
                alert('Изменения сохранены!');
            } catch (e) {
                alert('Ошибка сохранения: ' + e.message);
            }
        }

        function resetWorksData() {
            if (confirm('Сбросить все работы к исходным значениям? Это действие нельзя отменить.')) {
                state.percentages = JSON.parse(JSON.stringify(defaultPercentages));
                state.fixedValues = JSON.parse(JSON.stringify(defaultFixedValues));
                state.integrationsData = JSON.parse(JSON.stringify(defaultIntegrations));
                state.disabledWorks = { percentages: [], fixed: [], integrations: [] };
                
                localStorage.removeItem('calculatorPercentages');
                localStorage.removeItem('calculatorFixedValues');
                localStorage.removeItem('calculatorIntegrationsData');
                localStorage.removeItem('calculatorDisabledWorks');
                
                renderWorksAdminPanel();
                renderFixedWorks();
                calculateTotals();
                saveState();
                
                alert('Работы сброшены к исходным значениям');
            }
        }

        // Load works data from localStorage
        function loadWorksData() {
            try {
                const savedPercentages = localStorage.getItem('calculatorPercentages');
                const savedFixedValues = localStorage.getItem('calculatorFixedValues');
                const savedIntegrationsData = localStorage.getItem('calculatorIntegrationsData');
                const savedDisabledWorks = localStorage.getItem('calculatorDisabledWorks');
                
                if (savedPercentages) {
                    state.percentages = { ...state.percentages, ...JSON.parse(savedPercentages) };
                }
                if (savedFixedValues) {
                    state.fixedValues = { ...state.fixedValues, ...JSON.parse(savedFixedValues) };
                }
                if (savedIntegrationsData) {
                    state.integrationsData = { ...state.integrationsData, ...JSON.parse(savedIntegrationsData) };
                }
                if (savedDisabledWorks) {
                    state.disabledWorks = { ...state.disabledWorks, ...JSON.parse(savedDisabledWorks) };
                }
            } catch (e) {
                console.error('Error loading works data:', e);
            }
        }

        // Close works admin panel on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const panel = document.getElementById('worksAdminPanel');
                if (panel.classList.contains('active')) {
                    toggleWorksAdminPanel();
                }
            }
        });

        // Close works admin panel on click outside
        document.getElementById('worksAdminPanel').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleWorksAdminPanel();
            }
        });

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>